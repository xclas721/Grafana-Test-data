<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ACS 測試數據插入工具</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <div class="mode-switch-container">
        <div class="mode-switch">
          <button id="unifiedMode" class="mode-btn active" onclick="switchMode('unified')">
            統一模式
          </button>
          <button id="acsMode" class="mode-btn" onclick="switchMode('acs')">ACS 模式</button>
          <button id="dssMode" class="mode-btn" onclick="switchMode('dss')">3DSS 模式</button>
        </div>
      </div>

      <div class="form-container">
        <div class="quick-actions">
          <button class="quick-btn" onclick="loadDefaultValues()">載入預設值</button>
          <button class="quick-btn" onclick="generateRandomData()">生成隨機數據</button>
          <button class="quick-btn btn-primary" onclick="insertTestData()">插入測試數據</button>
          <div class="batch-container">
            <label for="batchCount" style="font-size: 12px; color: #666">數量:</label>
            <input
              type="number"
              id="batchCount"
              value="10"
              min="1"
              max="100000"
              class="batch-input"
              placeholder="10"
            />
            <label for="batchDays" style="font-size: 12px; color: #666">天數:</label>
            <input
              type="number"
              id="batchDays"
              value="1"
              min="1"
              max="30"
              class="batch-input"
              placeholder="1"
              title="生成多少天的數據"
            />
            <button class="quick-btn btn-success" onclick="batchGenerateAndInsert()">
              批量生成並POST
            </button>
          </div>
        </div>

        <div id="statusMessage"></div>

        <form id="acsForm">
          <!-- 基礎配置 -->
          <div class="form-section">
            <h3>基礎配置 <span id="modeIndicator" class="mode-indicator unified">統一</span></h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="baseUrl" class="bilingual-label">
                  <span class="zh">Elasticsearch URL</span>
                  <span class="en">base_url</span>
                </label>
                <input type="url" id="baseUrl" value="http://localhost:9200" required />
                <small>Elasticsearch 服務地址</small>
              </div>
              <div class="form-group">
                <label for="username" class="bilingual-label">
                  <span class="zh">用戶名</span>
                  <span class="en">username</span>
                </label>
                <input type="text" id="username" value="elastic" required />
              </div>
              <div class="form-group">
                <label for="password" class="bilingual-label">
                  <span class="zh">密碼</span>
                  <span class="en">password</span>
                </label>
                <input type="password" id="password" value="123456" required />
              </div>
              <div class="form-group">
                <label for="currentDate" class="bilingual-label">
                  <span class="zh">當前日期</span>
                  <span class="en">current_date</span>
                </label>
                <input type="date" id="currentDate" required />
                <small>交易日期 (YYYY-MM-DD-HH:MM:SS)</small>
                <small style="color: red"
                  >HH:MM:SS將自動生成隨機時間，並依據時區轉換為 UTC
                  時間，根據UTC時間決定儲存的索引名稱</small
                >
              </div>
              <div class="form-group">
                <label for="timezone" class="bilingual-label">
                  <span class="zh">時區</span>
                  <span class="en">timezone</span>
                </label>
                <select id="timezone" required>
                  <option value="browser">瀏覽器時區 (自動檢測)</option>
                  <option value="Asia/Taipei">台灣 (UTC+8)</option>
                  <option value="Asia/Shanghai">中國 (UTC+8)</option>
                  <option value="Asia/Tokyo">日本 (UTC+9)</option>
                  <option value="Asia/Seoul">韓國 (UTC+9)</option>
                  <option value="Asia/Singapore">新加坡 (UTC+8)</option>
                  <option value="Asia/Hong_Kong">香港 (UTC+8)</option>
                  <option value="America/New_York">美國東部 (UTC-5/-4)</option>
                  <option value="America/Los_Angeles">美國西部 (UTC-8/-7)</option>
                  <option value="Europe/London">英國 (UTC+0/+1)</option>
                  <option value="Europe/Paris">法國 (UTC+1/+2)</option>
                  <option value="Australia/Sydney">澳洲東部 (UTC+10/+11)</option>
                  <option value="UTC">UTC (UTC+0)</option>
                </select>
                <small>選擇時區用於時間轉換，預設使用瀏覽器時區</small>
              </div>
              <div class="form-group">
                <label class="bilingual-label">
                  <span class="zh">UTC時間區間</span>
                  <span class="en">Time Range</span>
                </label>
                <div
                  id="timeRangeDisplay"
                  style="padding: 8px; background: #f8f9fa; border-radius: 4px"
                >
                  <span id="timeRangeText" style="color: #7f8c8d">請選擇日期</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 交易識別 -->
          <div class="form-section">
            <h3>1.交易識別</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="issuerOid" class="bilingual-label">
                  <span class="zh">發卡機構 OID</span>
                  <span class="en">issuerOid</span>
                </label>
                <input
                  type="text"
                  id="issuerOid"
                  value="06b4b203-da05-73f9-256f-454929df6076"
                  required
                />
              </div>
              <div class="form-group">
                <label for="acsTransId" class="bilingual-label">
                  <span class="zh">ACS 交易 ID</span>
                  <span class="en">acsTransID</span>
                </label>
                <input
                  type="text"
                  id="acsTransId"
                  value="17616cb5-96d5-42cb-990a-08b28ff72874"
                  required
                />
                <small style="color: red">可隨機生成</small>
              </div>
              <div class="form-group">
                <label for="threeDSServerTransId" class="bilingual-label">
                  <span class="zh">3DS Server 交易 ID</span>
                  <span class="en">threeDSServerTransID</span>
                </label>
                <input
                  type="text"
                  id="threeDSServerTransId"
                  value="79c42c48-b25a-49f1-a791-fb45123cd944"
                  required
                />
                <small style="color: red">可隨機生成</small>
              </div>
            </div>
          </div>

          <!-- 交易狀態 -->
          <div class="form-section">
            <h3>2.交易狀態</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="aresTransStatus" class="bilingual-label">
                  <span class="zh">ARes 交易狀態</span>
                  <span class="en">ares_transStatus</span>
                </label>
                <select id="aresTransStatus" required>
                  <option value="Y">Y</option>
                  <option value="N" selected>N</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                  <option value="R">R</option>
                  <option value="A">A</option>
                  <option value="I">I</option>
                  <option value="S">S</option>
                  <option value="U">U</option>
                </select>
                <small style="color: red">可隨機生成</small>
              </div>
              <div class="form-group">
                <label for="transStatus" class="bilingual-label">
                  <span class="zh">交易狀態</span>
                  <span class="en">transStatus</span>
                </label>
                <input type="text" id="transStatus" value="N" required />
                <small>通常等於 ARes 交易狀態</small>
              </div>
              <div class="form-group">
                <label for="rreqTransStatus" class="bilingual-label">
                  <span class="zh">RReq 交易狀態</span>
                  <span class="en">rreq_transStatus</span>
                </label>
                <select id="rreqTransStatus" disabled>
                  <option value="NULL_VALUE" selected>NULL_VALUE</option>
                  <option value="Y">Y - 認證成功</option>
                  <option value="N">N - 認證失敗</option>
                </select>
                <small>只有當 ARes 狀態為 C/D 時才可選擇</small>
                <small style="color: red">可隨機生成</small>
              </div>
              <div class="form-group">
                <label for="transStatusReason" class="bilingual-label">
                  <span class="zh">交易狀態原因</span>
                  <span class="en">transStatusReason</span>
                </label>
                <select id="transStatusReason" disabled>
                  <option value="NULL_VALUE" selected>NULL_VALUE</option>
                  <option value="01">01 - Card authentication failed</option>
                  <option value="02">02 - Unknown device</option>
                  <option value="03">03 - Unsupported device</option>
                  <option value="04">04 - Exceeds authentication frequency limit</option>
                  <option value="05">05 - Expired card</option>
                  <option value="06">06 - Invalid card number</option>
                  <option value="07">07 - Invalid transaction</option>
                  <option value="08">08 - No card record</option>
                  <option value="09">09 - Security failure</option>
                  <option value="10">10 - Stolen card</option>
                  <option value="11">11 - Suspected fraud</option>
                  <option value="12">12 - Transaction not permitted to Cardholder</option>
                  <option value="13">13 - Cardholder not enrolled in service</option>
                  <option value="14">14 - Transaction timed out at the ACS</option>
                  <option value="15">15 - Low confidence</option>
                  <option value="16">16 - Medium confidence</option>
                  <option value="17">17 - High confidence</option>
                  <option value="18">18 - Very high confidence</option>
                  <option value="19">19 - Exceeds ACS maximum challenges</option>
                  <option value="20">20 - Non-Payment transaction not supported</option>
                  <option value="21">21 - 3RI transaction not supported</option>
                  <option value="22">22 - ACS technical issue</option>
                  <option value="23">
                    23 - Decoupled Authentication required by ACS but not requested by 3DS Requestor
                  </option>
                  <option value="24">24 - 3DS Requestor Decoupled Max Expiry Time exceeded</option>
                  <option value="25">
                    25 - Decoupled Authentication was provided insufficient time to authenticate
                    Cardholder. ACS will not make attempt
                  </option>
                  <option value="26">
                    26 - Authentication attempted but not performed by the Cardholder
                  </option>
                  <option value="27">27 - Preferred Authentication Method not supported</option>
                  <option value="28">28 - Validation of content security policy failed</option>
                  <option value="29">
                    29 - Authentication attempted but not completed by the Cardholder. Fall back to
                    Decoupled Authentication
                  </option>
                  <option value="30">
                    30 - Authentication completed successfully but additional authentication of the
                    Cardholder required. Reinitiate as Decoupled Authentication
                  </option>
                  <option value="81">81 - Mastercard SCA Exemption</option>
                  <option value="89">89 - Visa SCP Exemption</option>
                  <option value="90">90 - Visa Issuer SCA Required</option>
                </select>
                <small>只有當 ARes 狀態為 R 時才可選擇</small>
                <small style="color: red">可隨機生成</small>
              </div>
            </div>
          </div>

          <!-- 商戶信息 -->
          <div class="form-section">
            <h3>3.商戶信息</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="merchantName" class="bilingual-label">
                  <span class="zh">商戶名稱</span>
                  <span class="en">merchantName</span>
                </label>
                <input type="text" id="merchantName" value="HiTRUST EMV Demo Merchant" required />
              </div>
              <div class="form-group">
                <label for="merchantCountryCode" class="bilingual-label">
                  <span class="zh">商戶國家代碼</span>
                  <span class="en">merchantCountryCode</span>
                </label>
                <select id="merchantCountryCode" required>
                  <option value="156" selected>156 - 中國 (CN)</option>
                  <option value="158">158 - 台灣 (TW)</option>
                  <option value="840">840 - 美國 (US)</option>
                  <option value="392">392 - 日本 (JP)</option>
                  <option value="344">344 - 香港 (HK)</option>
                  <option value="410">410 - 韓國 (KR)</option>
                  <option value="702">702 - 新加坡 (SG)</option>
                  <option value="036">036 - 澳洲 (AU)</option>
                  <option value="124">124 - 加拿大 (CA)</option>
                  <option value="978">978 - 歐元區 (EU)</option>
                  <option value="826">826 - 英國 (GB)</option>
                  <option value="764">764 - 泰國 (TH)</option>
                  <option value="704">704 - 越南 (VN)</option>
                  <option value="458">458 - 馬來西亞 (MY)</option>
                  <option value="360">360 - 印尼 (ID)</option>
                  <option value="608">608 - 菲律賓 (PH)</option>
                </select>
                <small>選擇商戶所在國家/地區</small>
              </div>
              <div class="form-group">
                <label for="acquirerMerchantId" class="bilingual-label">
                  <span class="zh">收單機構商戶 ID</span>
                  <span class="en">acquirerMerchantID</span>
                </label>
                <input type="text" id="acquirerMerchantId" value="8909191" required />
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px">
                  <input
                    type="checkbox"
                    id="enableAcquirerMerchantIdRandom"
                    style="margin: 0"
                    checked
                  />
                  <label
                    for="enableAcquirerMerchantIdRandom"
                    style="margin: 0; font-weight: normal; color: #7f8c8d; font-size: 0.9em"
                    >隨機生成時包含此欄位</label
                  >
                </div>
                <small style="color: red">可隨機生成 (1-9999999)，預設關閉</small>
              </div>
              <div class="form-group">
                <label for="acquirerBin" class="bilingual-label">
                  <span class="zh">收單機構 BIN</span>
                  <span class="en">acquirerBIN</span>
                </label>
                <input type="text" id="acquirerBin" value="1231234" required />
              </div>
              <div class="form-group">
                <label for="mcc" class="bilingual-label">
                  <span class="zh">商戶類別代碼</span>
                  <span class="en">mcc</span>
                </label>
                <input type="text" id="mcc" value="5661" required />
              </div>
            </div>
          </div>

          <!-- 交易金額 -->
          <div class="form-section">
            <h3>4.交易金額</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="purchaseAmount" class="bilingual-label">
                  <span class="zh">購買金額</span>
                  <span class="en">purchaseAmount</span>
                </label>
                <input type="number" id="purchaseAmount" value="100" step="0.01" required />
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px">
                  <input
                    type="checkbox"
                    id="enablePurchaseAmountRandom"
                    style="margin: 0"
                    checked
                  />
                  <label
                    for="enablePurchaseAmountRandom"
                    style="margin: 0; font-weight: normal; color: #7f8c8d; font-size: 0.9em"
                    >隨機生成時包含此欄位</label
                  >
                </div>
                <small style="color: red">可隨機生成 (10-1000)，預設開啟</small>
              </div>
              <div class="form-group">
                <label for="purchaseCurrency" class="bilingual-label">
                  <span class="zh">購買貨幣代碼</span>
                  <span class="en">purchaseCurrency</span>
                </label>
                <select id="purchaseCurrency" required>
                  <option value="156" selected>156 - 中國人民幣 (CNY)</option>
                  <option value="901">901 - 台灣新台幣 (TWD)</option>
                  <option value="840">840 - 美國美元 (USD)</option>
                  <option value="392">392 - 日本日圓 (JPY)</option>
                  <option value="344">344 - 香港港幣 (HKD)</option>
                  <option value="410">410 - 韓國韓元 (KRW)</option>
                  <option value="702">702 - 新加坡新加坡元 (SGD)</option>
                  <option value="036">036 - 澳洲澳幣（澳元） (AUD)</option>
                  <option value="124">124 - 加拿大加幣（加元） (CAD)</option>
                  <option value="978">978 - 歐元區歐元 (EUR)</option>
                  <option value="826">826 - 英國英鎊 (GBP)</option>
                  <option value="764">764 - 泰國泰銖 (THB)</option>
                  <option value="704">704 - 越南越南盾 (VND)</option>
                  <option value="458">458 - 馬來西亞馬幣（令吉） (MYR)</option>
                  <option value="360">360 - 印尼印尼盾（盧比） (IDR)</option>
                  <option value="608">608 - 菲律賓菲律賓比索 (PHP)</option>
                </select>
                <small>選擇貨幣類型</small>
              </div>
              <div class="form-group">
                <label for="purchaseExponent" class="bilingual-label">
                  <span class="zh">購買金額指數</span>
                  <span class="en">purchaseExponent</span>
                </label>
                <input type="number" id="purchaseExponent" value="2" required />
              </div>
              <div class="form-group">
                <label for="usdAmount" class="bilingual-label">
                  <span class="zh">美元金額</span>
                  <span class="en">usdAmount</span>
                </label>
                <input
                  type="number"
                  id="usdAmount"
                  value="0.13841979956813022"
                  step="0.000000000000000001"
                />
              </div>
            </div>
          </div>

          <!-- 國家和貨幣信息 -->
          <div class="form-section">
            <h3>5.國家和貨幣信息</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="countryAlpha2" class="bilingual-label">
                  <span class="zh">國家代碼 (Alpha-2)</span>
                  <span class="en">countryAlpha2</span>
                </label>
                <input type="text" id="countryAlpha2" value="CN" maxlength="2" />
              </div>
              <div class="form-group">
                <label for="countryNumeric" class="bilingual-label">
                  <span class="zh">國家代碼 (數字)</span>
                  <span class="en">countryNumeric</span>
                </label>
                <input type="text" id="countryNumeric" value="156" />
              </div>
              <div class="form-group">
                <label for="countryAlpha3" class="bilingual-label">
                  <span class="zh">國家代碼 (Alpha-3)</span>
                  <span class="en">countryAlpha3</span>
                </label>
                <input type="text" id="countryAlpha3" value="CHN" maxlength="3" />
              </div>
              <div class="form-group">
                <label for="countryName" class="bilingual-label">
                  <span class="zh">國家名稱 (英文)</span>
                  <span class="en">countryName</span>
                </label>
                <input type="text" id="countryName" value="China" />
              </div>
              <div class="form-group">
                <label for="currencyMinorUnit" class="bilingual-label">
                  <span class="zh">貨幣小數位數</span>
                  <span class="en">currencyMinorUnit</span>
                </label>
                <input type="number" id="currencyMinorUnit" value="2" />
              </div>
              <div class="form-group">
                <label for="currencyName" class="bilingual-label">
                  <span class="zh">貨幣名稱 (英文)</span>
                  <span class="en">currencyName</span>
                </label>
                <input type="text" id="currencyName" value="Yuan Renminbi" />
              </div>
              <div class="form-group">
                <label for="currencyAlphabeticCode" class="bilingual-label">
                  <span class="zh">貨幣代碼 (字母)</span>
                  <span class="en">currencyAlphabeticCode</span>
                </label>
                <input type="text" id="currencyAlphabeticCode" value="CNY" maxlength="3" />
              </div>
              <div class="form-group">
                <label for="currencyNumericCode" class="bilingual-label">
                  <span class="zh">貨幣代碼 (數字)</span>
                  <span class="en">currencyNumericCode</span>
                </label>
                <input type="text" id="currencyNumericCode" value="156" />
              </div>
            </div>
          </div>

          <!-- 匯率信息 -->
          <div class="form-section">
            <h3>6.匯率信息</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="exchangeRate" class="bilingual-label">
                  <span class="zh">匯率</span>
                  <span class="en">exchangeRate</span>
                </label>
                <input type="number" id="exchangeRate" value="7.2244" step="0.0001" />
              </div>
              <div class="form-group">
                <label for="exchangeBase" class="bilingual-label">
                  <span class="zh">基礎貨幣</span>
                  <span class="en">exchangeBase</span>
                </label>
                <input type="text" id="exchangeBase" value="USD" />
              </div>
              <div class="form-group">
                <label for="exchangeTarget" class="bilingual-label">
                  <span class="zh">目標貨幣</span>
                  <span class="en">exchangeTarget</span>
                </label>
                <input type="text" id="exchangeTarget" value="CNY" />
              </div>
              <div class="form-group">
                <label for="currencyCodeForRate" class="bilingual-label">
                  <span class="zh">匯率貨幣代碼</span>
                  <span class="en">currencyCodeForRate</span>
                </label>
                <input type="text" id="currencyCodeForRate" value="CNY" />
              </div>
            </div>
          </div>

          <!-- 卡片信息 -->
          <div class="form-section">
            <h3>7.卡片信息</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="cardScheme" class="bilingual-label">
                  <span class="zh">卡片組織</span>
                  <span class="en">cardScheme</span>
                </label>
                <select id="cardScheme" required>
                  <option value="V" selected>V - Visa</option>
                  <option value="M">M - Mastercard</option>
                  <option value="J">J - JCB</option>
                  <option value="A">A - American Express</option>
                  <option value="C">C - UnionPay</option>
                  <option value="P">P - PayNet</option>
                  <option value="S">S - Saudi MADA</option>
                  <option value="E">E - EftPos</option>
                  <option value="U">U - EMVLab</option>
                </select>
              </div>
              <div class="form-group">
                <label for="acctNumber" class="bilingual-label">
                  <span class="zh">帳號原始值</span>
                  <span class="en">acctNumber</span>
                </label>
                <input
                  type="text"
                  id="acctNumber"
                  value="4143520000000123"
                  maxlength="19"
                  oninput="updateCardInfoFromAcctNumber()"
                />
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px">
                  <input type="checkbox" id="enableAcctNumberRandom" style="margin: 0" checked />
                  <label
                    for="enableAcctNumberRandom"
                    style="margin: 0; font-weight: normal; color: #7f8c8d; font-size: 0.9em"
                    >隨機生成時包含此欄位</label
                  >
                </div>
                <small style="color: red">此欄位不會 POST 出去，僅用於自動生成其他欄位</small>
                <small style="color: red">Visa: 4143520000000000~4143529999999999</small>
                <small style="color: red">MasterCard: 5153520000000000~5153529999999999</small>
              </div>
              <div class="form-group">
                <label for="cardbin6" class="bilingual-label">
                  <span class="zh">卡片 BIN (6位)</span>
                  <span class="en">cardbin6</span>
                </label>
                <input type="text" id="cardbin6" value="414352" maxlength="6" required disabled />
                <small>自動從帳號原始值前6碼生成</small>
              </div>
              <div class="form-group">
                <label for="acctNumberHashed" class="bilingual-label">
                  <span class="zh">帳號雜湊值</span>
                  <span class="en">acctNumberHashed</span>
                </label>
                <input
                  type="text"
                  id="acctNumberHashed"
                  value="2hpBkDB7ELbcpebGl5RM+HWTQGx3qciOwskcbsEVKC4="
                  disabled
                />
                <small>自動從帳號原始值計算 (HMAC-SHA256 + Base64)</small>
              </div>
              <div class="form-group">
                <label for="acctNumberMask" class="bilingual-label">
                  <span class="zh">帳號遮罩</span>
                  <span class="en">acctNumberMask</span>
                </label>
                <input type="text" id="acctNumberMask" value="414352******0123" disabled />
                <small>自動從帳號原始值生成（前6碼+******+後4碼）</small>
              </div>
              <div class="form-group">
                <label for="cardbin8" class="bilingual-label">
                  <span class="zh">卡片 BIN (8位)</span>
                  <span class="en">cardbin8</span>
                </label>
                <input type="text" id="cardbin8" value="41435200" maxlength="8" required disabled />
                <small>自動從帳號原始值前8碼生成</small>
              </div>

              <!-- 卡片組織擴展內容 -->
              <div class="form-group">
                <label for="visaDafMessageExtension" class="bilingual-label">
                  <span class="zh">Visa DAF 訊息擴展</span>
                  <span class="en">visaDafMessageExtension</span>
                </label>
                <input type="text" id="visaDafMessageExtension" value="null" />
              </div>
              <div class="form-group">
                <label for="mastercardMessageExtension" class="bilingual-label">
                  <span class="zh">Mastercard 訊息擴展</span>
                  <span class="en">mastercardMessageExtension</span>
                </label>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px">
                  <input type="checkbox" id="enableMastercardExtension" style="margin: 0" />
                  <label
                    for="enableMastercardExtension"
                    style="margin: 0; font-weight: normal; color: #7f8c8d; font-size: 0.9em"
                    >啟用 Mastercard 訊息擴展</label
                  >
                </div>
                <div
                  id="mastercardExtensionContainer"
                  style="
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    padding: 10px;
                    background: #f9f9f9;
                  "
                >
                  <div
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 10px;
                      margin-bottom: 10px;
                    "
                  >
                    <div>
                      <label for="mastercardScore" style="font-size: 0.8em; color: #666"
                        >Score (0-650)</label
                      >
                      <input
                        type="number"
                        id="mastercardScore"
                        value="600"
                        min="0"
                        max="650"
                        style="width: 100%; padding: 5px"
                      />
                    </div>
                    <div>
                      <label for="mastercardDecision" style="font-size: 0.8em; color: #666"
                        >Decision</label
                      >
                      <select id="mastercardDecision" style="width: 100%; padding: 5px">
                        <option value="Not Low Risk" selected>Not Low Risk</option>
                        <option value="Low Risk">Low Risk</option>
                      </select>
                    </div>
                  </div>
                  <div
                    style="
                      display: grid;
                      grid-template-columns: 1fr 1fr;
                      gap: 10px;
                      margin-bottom: 10px;
                    "
                  >
                    <div>
                      <label for="mastercardReasonCode1" style="font-size: 0.8em; color: #666"
                        >Reason Code 1</label
                      >
                      <input
                        type="text"
                        id="mastercardReasonCode1"
                        value="A"
                        maxlength="1"
                        style="width: 100%; padding: 5px"
                      />
                    </div>
                    <div>
                      <label for="mastercardReasonCode2" style="font-size: 0.8em; color: #666"
                        >Reason Code 2</label
                      >
                      <input
                        type="text"
                        id="mastercardReasonCode2"
                        value=""
                        maxlength="1"
                        style="width: 100%; padding: 5px"
                      />
                    </div>
                  </div>
                  <div>
                    <label for="mastercardStatus" style="font-size: 0.8em; color: #666"
                      >Status</label
                    >
                    <input
                      type="text"
                      id="mastercardStatus"
                      value="success"
                      style="width: 100%; padding: 5px"
                    />
                  </div>
                  <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px">
                    <input type="checkbox" id="enableMastercardExtensionRandom" style="margin: 0" />
                    <label
                      for="enableMastercardExtensionRandom"
                      style="margin: 0; font-weight: normal; color: #7f8c8d; font-size: 0.9em"
                      >隨機生成時包含此欄位</label
                    >
                  </div>
                  <small style="color: red">可隨機生成：Score、Decision，其他欄位保持預設值</small>
                </div>
              </div>
              <div class="form-group">
                <label for="visaRiskBasedAuthenticationScore" class="bilingual-label">
                  <span class="zh">Visa 風險基礎認證分數</span>
                  <span class="en">visaRiskBasedAuthenticationScore</span>
                </label>
                <input
                  type="number"
                  id="visaRiskBasedAuthenticationScore"
                  value=""
                  min="0"
                  max="99"
                  placeholder="留空為 NULL"
                />
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px">
                  <input type="checkbox" id="enableVisaScoreRandom" style="margin: 0" />
                  <label
                    for="enableVisaScoreRandom"
                    style="margin: 0; font-weight: normal; color: #7f8c8d; font-size: 0.9em"
                    >隨機生成時包含此欄位</label
                  >
                </div>
                <small style="color: red">可隨機生成 (0-99)，留空為 NULL</small>
              </div>
            </div>
          </div>

          <!-- 3DS 參數 -->
          <div class="form-section">
            <h3>7.3DS 參數</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="messageCategory" class="bilingual-label">
                  <span class="zh">訊息類別</span>
                  <span class="en">messageCategory</span>
                </label>
                <select id="messageCategory" required>
                  <option value="01" selected>01 - PA (Payment Authentication)</option>
                  <option value="02">02 - NPA (Non-Payment Authentication)</option>
                  <option value="80">80 - Mastercard Identity Check Insights</option>
                  <option value="85">85 - Mastercard PVPA</option>
                  <option value="86">86 - Mastercard PVNPA</option>
                </select>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px">
                  <input type="checkbox" id="enableMessageCategory" style="margin: 0" />
                  <label
                    for="enableMessageCategory"
                    style="margin: 0; font-weight: normal; color: #7f8c8d; font-size: 0.9em"
                    >隨機生成時包含此欄位</label
                  >
                </div>
                <small style="color: red">可隨機生成，預設關閉</small>
              </div>
              <div class="form-group">
                <label for="deviceChannel" class="bilingual-label">
                  <span class="zh">裝置通道</span>
                  <span class="en">deviceChannel</span>
                </label>
                <select id="deviceChannel" required>
                  <option value="02" selected>02 - Browser (BRW)</option>
                  <option value="03">03 - 3DS Requestor Initiated (3RI)</option>
                </select>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px">
                  <input type="checkbox" id="enableDeviceChannel" style="margin: 0" />
                  <label
                    for="enableDeviceChannel"
                    style="margin: 0; font-weight: normal; color: #7f8c8d; font-size: 0.9em"
                    >隨機生成時包含此欄位</label
                  >
                </div>
                <small style="color: red">可隨機生成，預設關閉</small>
              </div>
              <div class="form-group">
                <label for="threeDSRequestorChallengeInd" class="bilingual-label">
                  <span class="zh">3DS 請求方挑戰指標</span>
                  <span class="en">threeDSRequestorChallengeInd</span>
                </label>
                <select id="threeDSRequestorChallengeInd" required>
                  <option value="01" selected>01 = No preference</option>
                  <option value="02">02 = No challenge requested</option>
                  <option value="03">03 = Challenge requested: 3DS Requestor Preference</option>
                  <option value="04">04 = Challenge requested: Mandate</option>
                  <option value="05">
                    05 = No challenge requested (transactional risk analysis is already performed)
                  </option>
                  <option value="06">06 = No challenge requested (Data share only)</option>
                  <option value="07">
                    07 = No challenge requested (strong consumer authentication is already
                    performed)
                  </option>
                  <option value="08">
                    08 = No challenge requested (utilise Trust List exemption if no challenge
                    required)
                  </option>
                  <option value="09">
                    09 = Challenge requested (Trust List prompt requested if challenge required)
                  </option>
                  <option value="10">
                    10 = No challenge requested (utilise low value exemption)
                  </option>
                  <option value="11">
                    11 = No challenge requested (Secure corporate payment exemption)
                  </option>
                  <option value="12">
                    12 = Challenge requested (Device Binding prompt requested if challenge required)
                  </option>
                  <option value="13">13 = Challenge requested (Issuer requested)</option>
                  <option value="14">
                    14 = Challenge requested (Merchant initiated transactions)
                  </option>
                  <option value="80">
                    80 = (Visa) Remove specified VMID+PAN from Trusted Listing database
                  </option>
                  <option value="82">
                    82 = (Visa) NO CHALLENGE REQUESTED. Secure Corporate Exemption
                  </option>
                </select>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px">
                  <input
                    type="checkbox"
                    id="enableThreeDSRequestorChallengeInd"
                    style="margin: 0"
                  />
                  <label
                    for="enableThreeDSRequestorChallengeInd"
                    style="margin: 0; font-weight: normal; color: #7f8c8d; font-size: 0.9em"
                    >隨機生成時包含此欄位（Visa 才會隨機到 80/82）</label
                  >
                </div>
              </div>
              <div class="form-group">
                <label for="authenticationMethod" class="bilingual-label">
                  <span class="zh">認證方法</span>
                  <span class="en">authenticationMethod</span>
                </label>
                <input type="text" id="authenticationMethod" value="NULL_VALUE" />
              </div>
              <div class="form-group">
                <label for="authenticationType" class="bilingual-label">
                  <span class="zh">認證類型</span>
                  <span class="en">authenticationType</span>
                </label>
                <input type="text" id="authenticationType" value="NULL_VALUE" />
              </div>
            </div>
          </div>

          <!-- 效能監控 -->
          <div class="form-section">
            <h3>8.效能監控</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="performancePath" class="bilingual-label">
                  <span class="zh">Areq URL</span>
                  <span class="en">performancePath</span>
                </label>
                <input
                  type="text"
                  id="performancePath"
                  value="/acs-auth/auth/V/2.2.0/ed8544c4-fc50-289d-ee05-ee41c86bb6f5/001/areq"
                />
              </div>
              <div class="form-group">
                <label for="execTime" class="bilingual-label">
                  <span class="zh">執行時間 (毫秒)</span>
                  <span class="en">execTime</span>
                </label>
                <input type="number" id="execTime" value="5437" required />
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px">
                  <input type="checkbox" id="enableExecTimeRandom" style="margin: 0" checked />
                  <label
                    for="enableExecTimeRandom"
                    style="margin: 0; font-weight: normal; color: #7f8c8d; font-size: 0.9em"
                    >隨機生成時包含此欄位</label
                  >
                </div>
                <small style="color: red">可隨機生成 (1000-6000ms)，預設開啟</small>
              </div>
            </div>
          </div>

          <!-- 錯誤處理 -->
          <div class="form-section">
            <h3>9.錯誤處理(暫時都NULL_VALUE，也不隨機)</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="errorComponent" class="bilingual-label">
                  <span class="zh">錯誤組件</span>
                  <span class="en">errorComponent</span>
                </label>
                <input type="text" id="errorComponent" value="NULL_VALUE" />
              </div>
              <div class="form-group">
                <label for="errorDescription" class="bilingual-label">
                  <span class="zh">錯誤描述</span>
                  <span class="en">errorDescription</span>
                </label>
                <input type="text" id="errorDescription" value="NULL_VALUE" />
              </div>
              <div class="form-group">
                <label for="errorCode" class="bilingual-label">
                  <span class="zh">錯誤代碼</span>
                  <span class="en">errorCode</span>
                </label>
                <input type="text" id="errorCode" value="NULL_VALUE" />
              </div>
              <div class="form-group">
                <label for="errorDetail" class="bilingual-label">
                  <span class="zh">錯誤詳情</span>
                  <span class="en">errorDetail</span>
                </label>
                <input type="text" id="errorDetail" value="NULL_VALUE" />
              </div>
              <div class="form-group">
                <label for="errorMessageType" class="bilingual-label">
                  <span class="zh">錯誤訊息類型</span>
                  <span class="en">errorMessageType</span>
                </label>
                <input type="text" id="errorMessageType" value="NULL_VALUE" />
              </div>
            </div>
          </div>

          <!-- 插入測試數據按鈕已移至快速操作區域 -->
        </form>

        <!-- 舊的載入和回應區域已移除，使用通知面板取代 -->
      </div>
    </div>

    <!-- 增強的通知面板 -->
    <div id="notificationPanel" class="notification-panel">
      <div class="notification-header">
        <div class="notification-title">批量操作進度</div>
        <button class="notification-minimize" onclick="minimizeNotification()" title="最小化">
          −
        </button>
        <button class="notification-close" onclick="closeNotification()" title="關閉">×</button>
      </div>
      <div class="notification-content">
        <div class="progress-section">
          <div class="progress-text">
            <span id="progressStatus">準備中...</span>
            <span id="progressCount">0 / 0</span>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
          </div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-number" id="successCount">0</div>
              <div class="stat-label">成功</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="errorCount">0</div>
              <div class="stat-label">失敗</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="totalCount">0</div>
              <div class="stat-label">總計</div>
            </div>
            <div class="stat-item">
              <div class="stat-number" id="elapsedTime">0s</div>
              <div class="stat-label">耗時</div>
            </div>
          </div>
        </div>
        <div class="log-section">
          <div class="log-header">
            <span>操作日誌</span>
            <button class="log-toggle" onclick="toggleLog()">展開/收起</button>
          </div>
          <div class="log-content" id="logContent" style="display: none">
            <div id="logEntries"></div>
          </div>
        </div>
        <div id="errorDetails" class="error-details" style="display: none">
          <div class="error-summary">錯誤詳情</div>
          <div class="error-list" id="errorList"></div>
        </div>
      </div>
    </div>

    <!-- 最小化的通知 -->
    <div
      id="minimizedNotification"
      class="notification-minimized"
      style="display: none"
      onclick="restoreNotification()"
    >
      <span id="minimizedText">!</span>
      <div class="badge" id="minimizedBadge">0</div>
    </div>

    <!-- 貨幣選擇器模態框 -->
    <div
      id="currencyModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
      "
    >
      <div
        style="
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 30px;
          border-radius: 10px;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
        "
      >
        <h3 style="margin-bottom: 20px; color: #2c3e50">選擇貨幣</h3>
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
          "
        >
          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('901', 'TWD', '新台幣', '台灣')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>台灣</strong><br />
            新台幣 (TWD)<br />
            <small style="color: #666">代碼: 901</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('840', 'USD', '美元', '美國')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>美國</strong><br />
            美元 (USD)<br />
            <small style="color: #666">代碼: 840</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('156', 'CNY', '人民幣', '中國')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>中國</strong><br />
            人民幣 (CNY)<br />
            <small style="color: #666">代碼: 156</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('392', 'JPY', '日圓', '日本')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>日本</strong><br />
            日圓 (JPY)<br />
            <small style="color: #666">代碼: 392</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('344', 'HKD', '港幣', '香港')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>香港</strong><br />
            港幣 (HKD)<br />
            <small style="color: #666">代碼: 344</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('410', 'KRW', '韓元', '韓國')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>韓國</strong><br />
            韓元 (KRW)<br />
            <small style="color: #666">代碼: 410</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('702', 'SGD', '新加坡元', '新加坡')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>新加坡</strong><br />
            新加坡元 (SGD)<br />
            <small style="color: #666">代碼: 702</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('036', 'AUD', '澳幣（澳元）', '澳洲')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>澳洲</strong><br />
            澳幣（澳元） (AUD)<br />
            <small style="color: #666">代碼: 036</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('124', 'CAD', '加幣（加元）', '加拿大')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>加拿大</strong><br />
            加幣（加元） (CAD)<br />
            <small style="color: #666">代碼: 124</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('978', 'EUR', '歐元', '歐元區')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>歐元區</strong><br />
            歐元 (EUR)<br />
            <small style="color: #666">代碼: 978</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('826', 'GBP', '英鎊', '英國')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>英國</strong><br />
            英鎊 (GBP)<br />
            <small style="color: #666">代碼: 826</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('764', 'THB', '泰銖', '泰國')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>泰國</strong><br />
            泰銖 (THB)<br />
            <small style="color: #666">代碼: 764</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('704', 'VND', '越南盾', '越南')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>越南</strong><br />
            越南盾 (VND)<br />
            <small style="color: #666">代碼: 704</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('458', 'MYR', '馬幣（令吉）', '馬來西亞')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>馬來西亞</strong><br />
            馬幣（令吉） (MYR)<br />
            <small style="color: #666">代碼: 458</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('360', 'IDR', '印尼盾（盧比）', '印尼')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>印尼</strong><br />
            印尼盾（盧比） (IDR)<br />
            <small style="color: #666">代碼: 360</small>
          </div>

          <div
            style="
              padding: 10px;
              border: 1px solid #ddd;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
            "
            onclick="selectCurrency('608', 'PHP', '菲律賓比索', '菲律賓')"
            onmouseover="this.style.backgroundColor='#f0f0f0'"
            onmouseout="this.style.backgroundColor='white'"
          >
            <strong>菲律賓</strong><br />
            菲律賓比索 (PHP)<br />
            <small style="color: #666">代碼: 608</small>
          </div>
        </div>
        <button
          onclick="hideCurrencySelector()"
          style="
            padding: 10px 20px;
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          "
        >
          關閉
        </button>
      </div>
    </div>

    <script>
      // 時區轉換函數
      function convertToUTC(date, timezone) {
        // 創建 ISO 字符串
        const year = date.getFullYear()
        const month = String(date.getMonth() + 1).padStart(2, '0')
        const day = String(date.getDate()).padStart(2, '0')
        const hours = String(date.getHours()).padStart(2, '0')
        const minutes = String(date.getMinutes()).padStart(2, '0')
        const seconds = String(date.getSeconds()).padStart(2, '0')

        const isoString = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`

        // 使用 Intl.DateTimeFormat 來獲取指定時區的偏移量
        const testDate = new Date(isoString + 'Z') // 當作 UTC 時間
        const formatter = new Intl.DateTimeFormat('en', {
          timeZone: timezone,
          timeZoneName: 'longOffset'
        })

        const parts = formatter.formatToParts(testDate)
        const offsetPart = parts.find((part) => part.type === 'timeZoneName')

        if (offsetPart && offsetPart.value) {
          // 解析偏移量，例如 "GMT+08:00" 或 "GMT-05:00"
          const offsetMatch = offsetPart.value.match(/GMT([+-])(\d{2}):(\d{2})/)
          if (offsetMatch) {
            const sign = offsetMatch[1] === '+' ? 1 : -1
            const hours = parseInt(offsetMatch[2])
            const minutes = parseInt(offsetMatch[3])
            const totalOffsetMinutes = sign * (hours * 60 + minutes)

            // 轉換為 UTC：減去時區偏移量
            return new Date(date.getTime() - totalOffsetMinutes * 60 * 1000)
          }
        }

        // 如果無法解析，回退到瀏覽器時區
        const timezoneOffset = date.getTimezoneOffset()
        return new Date(date.getTime() + timezoneOffset * 60 * 1000)
      }

      // 獲取時區偏移量（分鐘）
      function getTimezoneOffset(timezone) {
        if (timezone === 'browser') {
          return new Date().getTimezoneOffset()
        }

        const now = new Date()
        const utc = new Date(now.getTime() + now.getTimezoneOffset() * 60000)
        const target = new Date(utc.toLocaleString('en-US', { timeZone: timezone }))
        return (utc.getTime() - target.getTime()) / 60000
      }

      // 獲取模式顯示名稱
      function getModeDisplayName(mode) {
        switch (mode) {
          case 'unified':
            return '統一'
          case 'acs':
            return 'ACS'
          case 'dss':
            return '3DSS'
          default:
            return '未知'
        }
      }

      // 更新插入按鈕文字
      function updateInsertButtonText(mode) {
        const insertBtn = document.querySelector('.quick-btn.btn-primary')
        if (insertBtn) {
          if (mode === 'unified') {
            insertBtn.textContent = '插入到 ACS & 3DSS'
          } else if (mode === 'acs') {
            insertBtn.textContent = '插入到 ACS'
          } else {
            insertBtn.textContent = '插入到 3DSS'
          }
        }
      }

      // 增強的通知系統變數
      let notificationState = {
        isVisible: false,
        isMinimized: false,
        startTime: null,
        totalCount: 0,
        currentCount: 0,
        successCount: 0,
        errorCount: 0,
        errors: [],
        logs: []
      }

      // 顯示增強的通知面板
      function showEnhancedNotification(totalCount) {
        notificationState = {
          isVisible: true,
          isMinimized: false,
          startTime: Date.now(),
          totalCount: totalCount,
          currentCount: 0,
          successCount: 0,
          errorCount: 0,
          errors: [],
          logs: []
        }

        // 重置 UI
        document.getElementById('notificationPanel').style.display = 'block'
        document.getElementById('minimizedNotification').style.display = 'none'
        updateProgressUI()
        addLogEntry('info', `開始批量操作，總計 ${totalCount} 條數據`)
      }

      // 更新進度 UI
      function updateProgressUI() {
        const progress =
          notificationState.totalCount > 0
            ? (notificationState.currentCount / notificationState.totalCount) * 100
            : 0

        // 更新進度條
        const progressBar = document.getElementById('progressBar')
        progressBar.style.width = `${progress}%`
        progressBar.textContent = `${Math.round(progress)}%`

        // 更新計數器
        document.getElementById('progressCount').textContent =
          `${notificationState.currentCount} / ${notificationState.totalCount}`
        document.getElementById('successCount').textContent = notificationState.successCount
        document.getElementById('errorCount').textContent = notificationState.errorCount
        document.getElementById('totalCount').textContent = notificationState.totalCount

        // 更新耗時
        if (notificationState.startTime) {
          const elapsed = Math.round((Date.now() - notificationState.startTime) / 1000)
          document.getElementById('elapsedTime').textContent = `${elapsed}s`
        }

        // 更新最小化通知的徽章
        const badge = document.getElementById('minimizedBadge')
        if (notificationState.errorCount > 0) {
          badge.textContent = notificationState.errorCount
          badge.style.display = 'flex'
        } else {
          badge.style.display = 'none'
        }
      }

      // 添加日誌條目
      function addLogEntry(type, message) {
        const timestamp = new Date().toLocaleTimeString()
        const logEntry = {
          timestamp,
          type,
          message
        }

        notificationState.logs.push(logEntry)

        // 更新日誌顯示
        const logEntries = document.getElementById('logEntries')
        const entryDiv = document.createElement('div')
        entryDiv.className = `log-entry ${type}`
        entryDiv.textContent = `[${timestamp}] ${message}`
        logEntries.appendChild(entryDiv)

        // 自動滾動到最新日誌
        logEntries.scrollTop = logEntries.scrollHeight

        // 限制日誌條目數量（保留最近 100 條）
        if (notificationState.logs.length > 100) {
          notificationState.logs.shift()
          const firstEntry = logEntries.firstChild
          if (firstEntry) {
            logEntries.removeChild(firstEntry)
          }
        }
      }

      // 更新錯誤詳情
      function updateErrorDetails() {
        const errorDetails = document.getElementById('errorDetails')
        const errorList = document.getElementById('errorList')

        if (notificationState.errors.length > 0) {
          errorDetails.style.display = 'block'
          errorList.innerHTML = ''

          notificationState.errors.forEach((error, index) => {
            const errorItem = document.createElement('div')
            errorItem.className = 'error-item'
            errorItem.textContent = error
            errorList.appendChild(errorItem)
          })
        } else {
          errorDetails.style.display = 'none'
        }
      }

      // 關閉通知面板
      function closeNotification() {
        document.getElementById('notificationPanel').style.display = 'none'
        document.getElementById('minimizedNotification').style.display = 'none'
        notificationState.isVisible = false
        notificationState.isMinimized = false
      }

      // 最小化通知面板
      function minimizeNotification() {
        document.getElementById('notificationPanel').style.display = 'none'
        document.getElementById('minimizedNotification').style.display = 'flex'
        notificationState.isMinimized = true
      }

      // 還原通知面板
      function restoreNotification() {
        document.getElementById('notificationPanel').style.display = 'block'
        document.getElementById('minimizedNotification').style.display = 'none'
        notificationState.isMinimized = false
      }

      // 切換日誌顯示
      function toggleLog() {
        const logContent = document.getElementById('logContent')
        const isVisible = logContent.style.display !== 'none'
        logContent.style.display = isVisible ? 'none' : 'block'
      }

      // 批量生成並插入測試數據（增強版）
      async function batchGenerateAndInsert() {
        const countInput = document.getElementById('batchCount')
        const daysInput = document.getElementById('batchDays')
        const count = parseInt(countInput.value) || 10
        const days = parseInt(daysInput.value) || 1

        if (count < 1 || count > 100000) {
          showStatus('請輸入 1-100000 之間的有效次數', 'error')
          return
        }

        if (days < 1 || days > 30) {
          showStatus('請輸入 1-30 之間的有效天數', 'error')
          return
        }

        const batchBtn = event.target
        const originalText = batchBtn.textContent

        try {
          // 顯示增強的通知面板
          showEnhancedNotification(count)

          // 移除 showLoading，使用通知面板顯示進度
          batchBtn.textContent = `批量處理中... (0/${count})`
          batchBtn.disabled = true

          // 更新狀態
          document.getElementById('progressStatus').textContent = '正在處理...'

          let totalProcessed = 0
          const totalItems = count

          // 預先隨機分配每天的量 - 使用更平衡的隨機分配
          const dailyCounts = []
          const averagePerDay = totalItems / days
          const minPerDay = Math.max(2, Math.floor(averagePerDay * 0.4)) // 最少是平均值的40%，且至少2筆
          const maxPerDay = Math.ceil(averagePerDay * 1.6) // 最多是平均值的160%

          // 先給每天分配最小值
          for (let day = 0; day < days; day++) {
            dailyCounts.push(minPerDay)
          }

          // 分配剩餘的數量
          let remainingItems = totalItems - minPerDay * days

          // 隨機分配剩餘數量
          while (remainingItems > 0) {
            const randomDay = Math.floor(Math.random() * days)
            const currentCount = dailyCounts[randomDay]
            const maxAllowed = Math.min(maxPerDay, currentCount + remainingItems)
            const canAdd = maxAllowed - currentCount

            if (canAdd > 0) {
              const addAmount = Math.min(
                canAdd,
                Math.floor(Math.random() * Math.min(remainingItems, 3)) + 1
              )
              dailyCounts[randomDay] += addAmount
              remainingItems -= addAmount
            }
          }

          // 獲取用戶選擇的起始日期
          const selectedDate = document.getElementById('currentDate').value
          const [selectedYear, selectedMonth, selectedDay] = selectedDate.split('-').map(Number)
          const startDate = new Date(selectedYear, selectedMonth - 1, selectedDay)

          // 保存原始日期，用於最後恢復
          const originalDate = selectedDate

          for (let day = 0; day < days; day++) {
            // 從用戶選擇的日期開始往前推
            const currentDate = new Date(startDate)
            currentDate.setDate(startDate.getDate() - day)
            const dateString =
              currentDate.getFullYear() +
              '-' +
              String(currentDate.getMonth() + 1).padStart(2, '0') +
              '-' +
              String(currentDate.getDate()).padStart(2, '0')

            // 設置當前天的日期（僅用於數據生成，不更新UI）
            document.getElementById('currentDate').value = dateString

            // 使用預先分配的隨機數量
            const itemsThisDay = dailyCounts[day]

            addLogEntry(
              'info',
              `開始生成第 ${day + 1} 天數據 (${dateString})，數量: ${itemsThisDay}`
            )

            // 使用優化的批量插入
            try {
              // 獲取表單數據作為基礎
              const baseFormData = getFormData()

              // 預先生成數據模板
              const templates = preGenerateDataTemplates(itemsThisDay, baseFormData)

              // 構建批量文檔
              const documents = buildBatchDocuments(
                templates,
                baseFormData,
                currentMode,
                dateString
              )

              // 執行批量插入（使用優化參數）
              const batchResult = await batchInsertOptimized(documents, baseFormData, 100, 5)

              // 更新統計
              totalProcessed += itemsThisDay
              notificationState.currentCount += itemsThisDay
              notificationState.successCount += batchResult.success
              notificationState.errorCount += batchResult.error
              notificationState.errors.push(...batchResult.errors)

              // 記錄結果
              if (batchResult.error === 0) {
                addLogEntry(
                  'success',
                  `第 ${day + 1} 天數據全部插入成功 (${dateString})，數量: ${itemsThisDay}`
                )
              } else {
                addLogEntry(
                  'warning',
                  `第 ${day + 1} 天數據部分插入成功 (${dateString})，成功: ${batchResult.success}，失敗: ${batchResult.error}`
                )
              }

              // 更新進度
              updateProgressUI()
              updateErrorDetails()
              batchBtn.textContent = `批量處理中... (${totalProcessed}/${totalItems})`
            } catch (error) {
              totalProcessed += itemsThisDay
              notificationState.currentCount += itemsThisDay
              notificationState.errorCount += itemsThisDay
              const errorMsg = `第 ${day + 1} 天數據處理異常 (${dateString}): ${error.message}`
              notificationState.errors.push(errorMsg)
              addLogEntry('error', errorMsg)

              updateProgressUI()
              updateErrorDetails()
              batchBtn.textContent = `批量處理中... (${totalProcessed}/${totalItems})`
            }
          }

          // 完成處理
          document.getElementById('progressStatus').textContent = '處理完成'

          // 恢復原始日期
          document.getElementById('currentDate').value = originalDate

          const actualSuccessCount = Math.floor(
            notificationState.successCount / (currentMode === 'unified' ? 2 : 1)
          )
          const actualErrorCount = Math.floor(
            notificationState.errorCount / (currentMode === 'unified' ? 2 : 1)
          )
          const indexInfo =
            currentMode === 'unified'
              ? ' (ACS + 3DSS 兩個索引)'
              : ` (${currentMode.toUpperCase()} 索引)`
          addLogEntry(
            'info',
            `批量操作完成！成功: ${actualSuccessCount} 筆數據, 失敗: ${actualErrorCount} 筆數據, 總記錄: ${notificationState.successCount}${indexInfo}`
          )

          // 顯示結果
          if (notificationState.errorCount === 0) {
            const actualDataCount = Math.floor(
              notificationState.successCount / (currentMode === 'unified' ? 2 : 1)
            )
            const indexInfo =
              currentMode === 'unified'
                ? ' (ACS + 3DSS 兩個索引)'
                : ` (${currentMode.toUpperCase()} 索引)`
            showStatus(
              `批量操作完成！成功插入 ${actualDataCount} 筆測試數據，共 ${notificationState.successCount} 條記錄${indexInfo}`,
              'success'
            )
          } else if (notificationState.successCount === 0) {
            const actualErrorCount = Math.floor(
              notificationState.errorCount / (currentMode === 'unified' ? 2 : 1)
            )
            const indexInfo =
              currentMode === 'unified'
                ? ' (ACS + 3DSS 兩個索引)'
                : ` (${currentMode.toUpperCase()} 索引)`
            showStatus(
              `批量操作失敗！所有 ${actualErrorCount} 筆數據都失敗，共 ${notificationState.errorCount} 條記錄${indexInfo}`,
              'error'
            )
          } else {
            const actualSuccessCount = Math.floor(
              notificationState.successCount / (currentMode === 'unified' ? 2 : 1)
            )
            const actualErrorCount = Math.floor(
              notificationState.errorCount / (currentMode === 'unified' ? 2 : 1)
            )
            const indexInfo =
              currentMode === 'unified'
                ? ' (ACS + 3DSS 兩個索引)'
                : ` (${currentMode.toUpperCase()} 索引)`
            showStatus(
              `批量操作部分成功！成功 ${actualSuccessCount} 筆數據，失敗 ${actualErrorCount} 筆數據，共 ${notificationState.successCount} 條記錄${indexInfo}`,
              'warning'
            )
          }
        } catch (error) {
          console.error('批量操作失敗:', error)

          // 恢復原始日期
          document.getElementById('currentDate').value = originalDate

          addLogEntry('error', `批量操作異常: ${error.message}`)
          showStatus('批量操作失敗: ' + error.message, 'error')
        } finally {
          // 移除 showLoading，使用通知面板顯示進度
          batchBtn.textContent = originalText
          batchBtn.disabled = false
        }
      }

      // 靜默插入測試數據（不顯示成功訊息）
      async function insertTestDataSilent() {
        try {
          const formData = getFormData()

          if (currentMode === 'unified') {
            // 統一模式：同時插入到 ACS 和 3DSS，使用相同的時間戳
            // 先生成一個共享的時間戳
            const sharedTimestamp = generateSharedTimestamp(formData)
            const acsResult = await insertToUnifiedIndexSilent(
              formData,
              'acs-transaction',
              sharedTimestamp
            )
            const dssResult = await insertToUnifiedIndexSilent(
              formData,
              '3dss-transaction',
              sharedTimestamp
            )

            if (acsResult.success && dssResult.success) {
              return { success: true }
            } else {
              const errors = []
              if (!acsResult.success) errors.push('ACS: ' + acsResult.error)
              if (!dssResult.success) errors.push('3DSS: ' + dssResult.error)
              return { success: false, error: errors.join(', ') }
            }
          } else {
            // 單一模式：插入到指定索引
            const indexName = currentMode === 'acs' ? 'acs-transaction' : '3dss-transaction'
            return await insertToSingleIndexSilent(formData, indexName)
          }
        } catch (error) {
          return { success: false, error: error.message }
        }
      }

      // 統一模式插入到單一索引（使用預先生成的時間戳）
      async function insertToUnifiedIndexSilent(formData, indexName, sharedTimestamp) {
        try {
          // 使用預先生成的時間戳構建文檔
          const document = buildElasticsearchDocumentWithTimestamp(
            formData,
            indexName,
            sharedTimestamp
          )
          // 基於 UTC 時間的日期來決定索引名稱
          const utcDateStr = document.last_update_timestamp.split('T')[0]
          const fullIndexName = `${indexName}-${utcDateStr}`

          // 構建 bulk API 請求
          const bulkData =
            [JSON.stringify({ index: { _index: fullIndexName } }), JSON.stringify(document)].join(
              '\n'
            ) + '\n'

          const response = await fetch(`${formData.baseUrl}/_bulk`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-ndjson',
              Authorization: 'Basic ' + btoa(`${formData.username}:${formData.password}`)
            },
            body: bulkData
          })

          if (!response.ok) {
            const errorText = await response.text()
            return { success: false, error: `HTTP ${response.status}: ${errorText}` }
          }

          const result = await response.json()
          if (result.errors) {
            const errorDetails = result.items
              .filter((item) => item.index && item.index.error)
              .map((item) => item.index.error.reason)
              .join(', ')
            return { success: false, error: errorDetails }
          }

          return { success: true }
        } catch (error) {
          return { success: false, error: error.message }
        }
      }

      // 靜默插入到單一索引
      async function insertToSingleIndexSilent(formData, indexName) {
        try {
          // 先構建文檔以獲取 UTC 時間
          const document = buildElasticsearchDocument(formData, indexName)
          // 基於 UTC 時間的日期來決定索引名稱
          const utcDateStr = document.last_update_timestamp.split('T')[0]
          const fullIndexName = `${indexName}-${utcDateStr}`

          // 構建 bulk API 請求
          const bulkData =
            [JSON.stringify({ index: { _index: fullIndexName } }), JSON.stringify(document)].join(
              '\n'
            ) + '\n'

          const response = await fetch(`${formData.baseUrl}/_bulk`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-ndjson',
              Authorization: 'Basic ' + btoa(`${formData.username}:${formData.password}`)
            },
            body: bulkData
          })

          const result = await response.json()

          if (response.ok) {
            return { success: true, result: result }
          } else {
            return { success: false, error: result.error || '插入失敗' }
          }
        } catch (error) {
          return { success: false, error: error.message }
        }
      }

      // ========== 效能優化函數 ==========

      // 預先生成數據模板，減少重複計算
      function preGenerateDataTemplates(count, baseFormData) {
        const templates = []

        // 預先生成一些卡號和商店ID用於重複
        const cardPool = []
        const merchantPool = []
        const cardPoolSize = Math.max(1, Math.floor(count * 0.1)) // 10% 重複，至少1個
        const merchantPoolSize = Math.max(1, Math.floor(count * 0.3)) // 30% 重複，至少1個

        // 生成卡號池
        for (let i = 0; i < cardPoolSize; i++) {
          const cardNumber = generateRandomAcctNumberValue(baseFormData.cardScheme || 'V')
          cardPool.push({
            acctNumber: cardNumber,
            acctNumberHashed: generateAcctNumberHashedSync(cardNumber),
            acctNumberMask: generateAcctNumberMask(cardNumber),
            cardbin6: cardNumber.substring(0, 6),
            cardbin8: cardNumber.substring(0, 8)
          })
        }

        // 生成商店ID池
        for (let i = 0; i < merchantPoolSize; i++) {
          merchantPool.push(Math.floor(Math.random() * 9999999) + 1)
        }

        for (let i = 0; i < count; i++) {
          // 決定是否使用重複的卡號 (10% 機率)
          let cardData
          if (Math.random() < 0.1 && cardPool.length > 0) {
            // 使用重複卡號
            cardData = cardPool[Math.floor(Math.random() * cardPool.length)]
          } else {
            // 生成新卡號
            const randomAcctNumber = generateRandomAcctNumberValue(baseFormData.cardScheme || 'V')
            cardData = {
              acctNumber: randomAcctNumber,
              acctNumberHashed: generateAcctNumberHashedSync(randomAcctNumber),
              acctNumberMask: generateAcctNumberMask(randomAcctNumber),
              cardbin6: randomAcctNumber.substring(0, 6),
              cardbin8: randomAcctNumber.substring(0, 8)
            }
          }

          // 決定是否使用重複的商店ID (30% 機率)
          let merchantId
          if (Math.random() < 0.3 && merchantPool.length > 0) {
            // 使用重複商店ID
            merchantId = merchantPool[Math.floor(Math.random() * merchantPool.length)]
          } else {
            // 生成新商店ID
            merchantId = Math.floor(Math.random() * 9999999) + 1
          }

          // 為每筆數據生成一次 Mastercard 擴展數據
          let mastercardData = null

          // 檢查是否啟用 Mastercard 擴展
          if (baseFormData.enableMastercardExtension === 'on') {
            // 如果啟用了隨機生成，則生成隨機數據
            if (baseFormData.enableMastercardExtensionRandom === 'on') {
              mastercardData = generateRandomMastercardExtension()
            } else {
              // 如果沒有啟用隨機生成，則使用表單中的預設值
              mastercardData = {
                score: parseInt(baseFormData.mastercardScore) || 600,
                decision: baseFormData.mastercardDecision || 'Not Low Risk'
              }
            }
          }
          // 如果沒有啟用 Mastercard 擴展，mastercardData 保持為 null

          const aresStatus = generateRealisticStatus()
          let rreqStatus = 'NULL_VALUE'
          let transStatus = aresStatus

          // 根據業務規則設置相關欄位
          if (['C', 'D'].includes(aresStatus)) {
            // 挑戰認證流程：有 rreq 結果，且 transStatus = rreq 結果
            rreqStatus = Math.random() < 0.8 ? 'Y' : 'N'
            transStatus = rreqStatus // 最終狀態 = 挑戰結果
          } else {
            // 無摩擦認證流程：無 rreq，transStatus = ares 狀態
            rreqStatus = 'NULL_VALUE'
            transStatus = aresStatus
          }

          let transStatusReason = 'NULL_VALUE'
          if (aresStatus === 'R') {
            const reasons = []
            for (let j = 1; j <= 30; j++) {
              reasons.push(j.toString().padStart(2, '0'))
            }
            reasons.push('81', '89', '90')
            transStatusReason = reasons[Math.floor(Math.random() * reasons.length)]
          }

          const template = {
            acsTransId: generateUUID(),
            threeDSServerTransId: generateUUID().toLowerCase(),
            purchaseAmount: generateRealisticPurchaseAmount(),
            execTime: generateRealisticExecTime(),
            aresTransStatus: aresStatus,
            transStatus: transStatus,
            rreqTransStatus: rreqStatus,
            transStatusReason: transStatusReason,
            messageCategory: generateRealisticMessageCategory(),
            deviceChannel: generateRealisticDeviceChannel(),
            acquirerMerchantId: merchantId,
            visaRiskBasedAuthenticationScore:
              baseFormData.enableVisaScoreRandom === 'on' ? generateRealisticVisaScore() : '',
            mastercardScore: mastercardData ? mastercardData.score : null,
            mastercardDecision: mastercardData ? mastercardData.decision : null,
            // 卡號相關欄位
            acctNumberHashed: cardData.acctNumberHashed,
            acctNumberMask: cardData.acctNumberMask,
            cardbin6: cardData.cardbin6,
            cardbin8: cardData.cardbin8
          }

          templates.push(template)
        }
        return templates
      }

      // 生成更真實的交易狀態分佈
      function generateRealisticStatus() {
        const random = Math.random()
        if (random < 0.4) return 'Y' // 40% 成功
        if (random < 0.45) return 'N' // 5% 失敗
        if (random < 0.5) return 'R' // 5% 拒絕
        if (random < 0.75) return 'C' // 25% 挑戰
        if (random < 0.8) return 'D' // 5% 其他
        if (random < 0.85) return 'A' // 5% 嘗試
        if (random < 0.9) return 'I' // 5% 僅資訊
        if (random < 0.95) return 'S' // 5% 使用 SPC 挑戰
        return 'U' // 5% 未執行
      }

      // 生成真實的購買金額分佈（偏向較小金額）
      function generateRealisticPurchaseAmount() {
        const random = Math.random()
        if (random < 0.4) return (Math.random() * 50 + 10).toFixed(2) // 40% 小額 (10-60)
        if (random < 0.7) return (Math.random() * 200 + 60).toFixed(2) // 30% 中額 (60-260)
        if (random < 0.9) return (Math.random() * 500 + 260).toFixed(2) // 20% 大額 (260-760)
        return (Math.random() * 240 + 760).toFixed(2) // 10% 超大額 (760-1000)
      }

      // 生成真實的執行時間分佈（偏向較短時間）
      function generateRealisticExecTime() {
        const random = Math.random()
        if (random < 0.5) return Math.floor(Math.random() * 1000 + 1000) // 50% 快速 (1000-2000ms)
        if (random < 0.8) return Math.floor(Math.random() * 1500 + 2000) // 30% 中等 (2000-3500ms)
        if (random < 0.95) return Math.floor(Math.random() * 1500 + 3500) // 15% 較慢 (3500-5000ms)
        return Math.floor(Math.random() * 1000 + 5000) // 5% 很慢 (5000-6000ms)
      }

      // 生成真實的訊息類別分佈
      function generateRealisticMessageCategory() {
        const random = Math.random()
        if (random < 0.8) return '01' // 80% 正常認證
        if (random < 0.9) return '02' // 10% 其他
        if (random < 0.95) return '80' // 5% 特殊情況
        if (random < 0.98) return '85' // 3% 錯誤處理
        return '86' // 2% 系統錯誤
      }

      // 生成真實的設備通道分佈
      function generateRealisticDeviceChannel() {
        const random = Math.random()
        if (random < 0.7) return '02' // 70% 瀏覽器
        return '03' // 30% 應用程式
      }

      // 生成真實的 Visa 分數分佈（偏向較低風險）
      function generateRealisticVisaScore() {
        const random = Math.random()
        if (random < 0.3) return Math.floor(Math.random() * 20) // 30% 低風險 (0-19)
        if (random < 0.6) return Math.floor(Math.random() * 30 + 20) // 30% 中低風險 (20-49)
        if (random < 0.8) return Math.floor(Math.random() * 30 + 50) // 20% 中風險 (50-79)
        return Math.floor(Math.random() * 20 + 80) // 20% 高風險 (80-99)
      }

      // 生成真實的 Mastercard 分數分佈
      function generateRealisticMastercardScore() {
        const random = Math.random()
        if (random < 0.4) return Math.floor(Math.random() * 200) // 40% 低分 (0-199)
        if (random < 0.7) return Math.floor(Math.random() * 200 + 200) // 30% 中分 (200-399)
        if (random < 0.9) return Math.floor(Math.random() * 150 + 400) // 20% 高分 (400-549)
        return Math.floor(Math.random() * 101 + 550) // 10% 很高分 (550-650)
      }

      // 生成真實的 Mastercard 決策分佈
      function generateRealisticMastercardDecision() {
        const random = Math.random()
        if (random < 0.3) return 'Low Risk' // 30% 低風險
        return 'Not Low Risk' // 70% 非低風險
      }

      // 生成隨機卡號值（不更新 DOM）
      function generateRandomAcctNumberValue(cardScheme) {
        let randomAcctNumber = ''

        if (cardScheme === 'V') {
          // Visa: 4143520000000000~4143529999999999
          const randomSuffix = Math.floor(Math.random() * 10000000000000)
            .toString()
            .padStart(13, '0')
          randomAcctNumber = '414352' + randomSuffix
        } else if (cardScheme === 'M') {
          // MasterCard: 5153520000000000~5153529999999999
          const randomSuffix = Math.floor(Math.random() * 10000000000000)
            .toString()
            .padStart(13, '0')
          randomAcctNumber = '515352' + randomSuffix
        } else {
          // 其他卡片組織，使用預設的 Visa 格式
          const randomSuffix = Math.floor(Math.random() * 10000000000000)
            .toString()
            .padStart(13, '0')
          randomAcctNumber = '414352' + randomSuffix
        }

        return randomAcctNumber
      }

      // 同步生成卡號雜湊值
      function generateAcctNumberHashedSync(acctNumber) {
        // 使用簡單的雜湊算法（因為 Web Crypto API 是異步的）
        let hash = 0
        for (let i = 0; i < acctNumber.length; i++) {
          const char = acctNumber.charCodeAt(i)
          hash = (hash << 5) - hash + char
          hash = hash & hash // 轉換為 32 位整數
        }
        // 轉換為 Base64 格式
        const hashStr = Math.abs(hash).toString(16).padStart(8, '0')
        return btoa(hashStr + acctNumber.substring(0, 8))
      }

      // 生成卡號遮罩
      function generateAcctNumberMask(acctNumber) {
        if (acctNumber.length >= 10) {
          const first6 = acctNumber.substring(0, 6)
          const last4 = acctNumber.substring(acctNumber.length - 4)
          return first6 + '******' + last4
        }
        return acctNumber
      }

      // 真正的批量插入函數
      async function batchInsertOptimized(
        documents,
        formData,
        batchSize = 100,
        maxConcurrency = 5
      ) {
        const results = {
          success: 0,
          error: 0,
          errors: []
        }

        // 將文檔分批
        const batches = []
        for (let i = 0; i < documents.length; i += batchSize) {
          batches.push(documents.slice(i, i + batchSize))
        }

        // 控制並發數量
        for (let i = 0; i < batches.length; i += maxConcurrency) {
          const concurrentBatches = batches.slice(i, i + maxConcurrency)
          const promises = concurrentBatches.map((batch) => processBatch(batch, formData))

          const batchResults = await Promise.allSettled(promises)

          batchResults.forEach((result, index) => {
            if (result.status === 'fulfilled') {
              results.success += result.value.success
              results.error += result.value.error
              results.errors.push(...result.value.errors)
            } else {
              results.error += concurrentBatches[index].length
              results.errors.push(`批次處理失敗: ${result.reason}`)
            }
          })
        }

        return results
      }

      // 處理單個批次
      async function processBatch(batch, formData) {
        const result = { success: 0, error: 0, errors: [] }

        // 按索引名稱分組
        const indexGroups = {}
        batch.forEach((doc) => {
          const indexName = doc.index
          if (!indexGroups[indexName]) {
            indexGroups[indexName] = []
          }
          indexGroups[indexName].push(doc)
        })

        // 為每個索引發送批量請求
        for (const [indexName, docs] of Object.entries(indexGroups)) {
          try {
            const bulkData = docs
              .map(
                (doc) =>
                  JSON.stringify({ index: { _index: indexName } }) +
                  '\n' +
                  JSON.stringify(doc.data) +
                  '\n'
              )
              .join('')

            const response = await fetch(`${formData.baseUrl}/_bulk`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-ndjson',
                Authorization: 'Basic ' + btoa(`${formData.username}:${formData.password}`)
              },
              body: bulkData
            })

            const responseData = await response.json()

            if (response.ok && !responseData.errors) {
              result.success += docs.length
            } else {
              result.error += docs.length
              if (responseData.errors) {
                const errorDetails =
                  responseData.items
                    ?.filter((item) => item.index && item.index.error)
                    ?.map((item) => item.index.error.reason)
                    ?.join(', ') || '批量插入失敗'
                result.errors.push(`${indexName}: ${errorDetails}`)
              } else {
                result.errors.push(`${indexName}: HTTP ${response.status}`)
              }
            }
          } catch (error) {
            result.error += docs.length
            result.errors.push(`${indexName}: ${error.message}`)
          }
        }

        return result
      }

      // 構建批量文檔
      function buildBatchDocuments(templates, formData, mode, dateString) {
        const documents = []

        templates.forEach((template) => {
          // 合併模板數據與表單數據
          const mergedData = { ...formData, ...template }

          // 如果模板中有 Mastercard 數據，需要重新構建 mastercardMessageExtension
          if (
            template.mastercardScore !== undefined &&
            template.mastercardScore !== null &&
            template.mastercardDecision !== undefined &&
            template.mastercardDecision !== null
          ) {
            const enableMastercardExtension = formData.enableMastercardExtension === 'on'
            if (enableMastercardExtension) {
              const mastercardExtension = {
                score: template.mastercardScore,
                reasonCode2: formData.mastercardReasonCode2 || '',
                reasonCode1: formData.mastercardReasonCode1 || 'A',
                decision: template.mastercardDecision,
                status: formData.mastercardStatus || 'success'
              }
              mergedData.mastercardMessageExtension = JSON.stringify(mastercardExtension)
            } else {
              mergedData.mastercardMessageExtension = 'null'
            }
          } else {
            // 如果沒有 Mastercard 數據，設為 null
            mergedData.mastercardMessageExtension = 'null'
          }

          if (mode === 'unified') {
            // 統一模式：生成共享時間戳
            const sharedTimestamp = generateSharedTimestamp(mergedData)

            // ACS 文檔
            const acsDoc = buildElasticsearchDocumentWithTimestamp(
              mergedData,
              'acs-transaction',
              sharedTimestamp
            )
            const acsIndexName = `acs-transaction-${acsDoc.last_update_timestamp.split('T')[0]}`
            documents.push({ index: acsIndexName, data: acsDoc })

            // 3DSS 文檔
            const dssDoc = buildElasticsearchDocumentWithTimestamp(
              mergedData,
              '3dss-transaction',
              sharedTimestamp
            )
            const dssIndexName = `3dss-transaction-${dssDoc.last_update_timestamp.split('T')[0]}`
            documents.push({ index: dssIndexName, data: dssDoc })
          } else {
            // 單一模式
            const indexName = mode === 'acs' ? 'acs-transaction' : '3dss-transaction'
            const doc = buildElasticsearchDocument(mergedData, indexName)
            const fullIndexName = `${indexName}-${doc.last_update_timestamp.split('T')[0]}`
            documents.push({ index: fullIndexName, data: doc })
          }
        })

        return documents
      }

      // 頁面載入完成後初始化
      document.addEventListener('DOMContentLoaded', function () {
        // 設定預設模式為統一模式
        currentMode = 'unified'
        updateInsertButtonText(currentMode)
        console.log('測試數據管理系統已載入，當前模式:', currentMode)
      })

      // 更新時間區間顯示
      function updateTimeRangeDisplay() {
        const currentDate = document.getElementById('currentDate').value
        const selectedTimezone = document.getElementById('timezone').value
        const batchDays = parseInt(document.getElementById('batchDays').value) || 1
        const timeRangeText = document.getElementById('timeRangeText')

        if (!currentDate) {
          timeRangeText.textContent = '請選擇日期'
          return
        }

        const now = new Date()
        const today =
          now.getFullYear() +
          '-' +
          String(now.getMonth() + 1).padStart(2, '0') +
          '-' +
          String(now.getDate()).padStart(2, '0')

        // 獲取時區名稱顯示
        const timezoneNames = {
          browser: '瀏覽器時區 (' + Intl.DateTimeFormat().resolvedOptions().timeZone + ')',
          'Asia/Taipei': '台灣 (UTC+8)',
          'Asia/Shanghai': '中國 (UTC+8)',
          'Asia/Tokyo': '日本 (UTC+9)',
          'Asia/Seoul': '韓國 (UTC+9)',
          'Asia/Singapore': '新加坡 (UTC+8)',
          'Asia/Hong_Kong': '香港 (UTC+8)',
          'America/New_York': '美國東部 (UTC-5/-4)',
          'America/Los_Angeles': '美國西部 (UTC-8/-7)',
          'Europe/London': '英國 (UTC+0/+1)',
          'Europe/Paris': '法國 (UTC+1/+2)',
          'Australia/Sydney': '澳洲東部 (UTC+10/+11)',
          UTC: 'UTC (UTC+0)'
        }

        const timezoneName = timezoneNames[selectedTimezone] || selectedTimezone

        // 計算多天範圍
        const [selectedYear, selectedMonth, selectedDay] = currentDate.split('-').map(Number)
        const startDate = new Date(selectedYear, selectedMonth - 1, selectedDay)

        // 計算最後一天的日期
        const endDate = new Date(startDate)
        endDate.setDate(startDate.getDate() - (batchDays - 1))

        // 根據是否為今天來決定時間範圍
        let utcStartDate, utcEndTime

        if (currentDate === today) {
          // 今天是今天，顯示限制時間
          const currentHour = now.getHours()
          const currentMinute = now.getMinutes()
          const currentSecond = now.getSeconds()

          if (selectedTimezone === 'browser') {
            // 使用瀏覽器時區
            const startDate = new Date(currentDate + 'T00:00:00')
            const endDate = new Date(
              currentDate +
                `T${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}:${currentSecond.toString().padStart(2, '0')}`
            )

            // 直接使用 Date 對象，toISOString() 會自動轉換為 UTC
            utcStartDate = startDate
            utcEndTime = endDate
          } else {
            // 使用指定時區 - 需要先獲取該時區的當前時間
            const startDate = new Date(currentDate + 'T00:00:00')

            // 獲取指定時區的當前時間
            const nowInTimezone = new Date(
              now.toLocaleString('en-US', { timeZone: selectedTimezone })
            )
            const currentHourInTimezone = nowInTimezone.getHours()
            const currentMinuteInTimezone = nowInTimezone.getMinutes()
            const currentSecondInTimezone = nowInTimezone.getSeconds()

            const endDate = new Date(
              currentDate +
                `T${currentHourInTimezone.toString().padStart(2, '0')}:${currentMinuteInTimezone.toString().padStart(2, '0')}:${currentSecondInTimezone.toString().padStart(2, '0')}`
            )

            // 對於 UTC 時區，直接使用日期，不需要轉換
            if (selectedTimezone === 'UTC') {
              utcStartDate = startDate
              utcEndTime = endDate
            } else {
              utcStartDate = convertToUTC(startDate, selectedTimezone)
              utcEndTime = convertToUTC(endDate, selectedTimezone)
            }
          }
        } else {
          // 過去日期，顯示完整 24 小時
          if (selectedTimezone === 'browser') {
            // 使用瀏覽器時區
            const startDate = new Date(currentDate + 'T00:00:00')
            const endDate = new Date(currentDate + 'T23:59:59')

            // 直接使用 Date 對象，toISOString() 會自動轉換為 UTC
            utcStartDate = startDate
            utcEndTime = endDate
          } else {
            // 使用指定時區
            const startDate = new Date(currentDate + 'T00:00:00')
            const endDate = new Date(currentDate + 'T23:59:59')

            // 對於 UTC 時區，直接使用日期，不需要轉換
            if (selectedTimezone === 'UTC') {
              utcStartDate = startDate
              utcEndTime = endDate
            } else {
              utcStartDate = convertToUTC(startDate, selectedTimezone)
              utcEndTime = convertToUTC(endDate, selectedTimezone)
            }
          }
        }

        const utcStartStr = utcStartDate.toISOString()
        const utcEndStr = utcEndTime.toISOString()

        // 計算多天範圍的 UTC 時間
        const endDateStr =
          endDate.getFullYear() +
          '-' +
          String(endDate.getMonth() + 1).padStart(2, '0') +
          '-' +
          String(endDate.getDate()).padStart(2, '0')

        const multiDayEndDate = new Date(endDateStr + 'T23:59:59')
        let multiDayUtcEnd
        if (selectedTimezone === 'browser') {
          // 直接使用 Date 對象，toISOString() 會自動轉換為 UTC
          multiDayUtcEnd = multiDayEndDate
        } else if (selectedTimezone === 'UTC') {
          // 對於 UTC 時區，直接使用日期，不需要轉換
          multiDayUtcEnd = multiDayEndDate
        } else {
          multiDayUtcEnd = convertToUTC(multiDayEndDate, selectedTimezone)
        }

        const multiDayUtcEndStr = multiDayUtcEnd.toISOString()

        if (batchDays === 1) {
          if (currentDate === today) {
            timeRangeText.innerHTML = `
                      <div style="font-size: 0.9em;">
                          <div><strong>選擇時區：</strong>${timezoneName}</div>
                          <div><strong>UTC 時間範圍：</strong>${utcStartStr} ~ ${utcEndStr}</div>
                          <div style="color: #666; margin-top: 5px;">
                              <small>注意：時間範圍限制在當前時間之前</small>
                          </div>
                      </div>
                  `
          } else {
            timeRangeText.innerHTML = `
                      <div style="font-size: 0.9em;">
                          <div><strong>選擇時區：</strong>${timezoneName}</div>
                          <div><strong>UTC 時間範圍：</strong>${utcStartStr} ~ ${utcEndStr}</div>
                          <div style="color: #666; margin-top: 5px;">
                              <small>注意：可以生成全天24小時的任意時間</small>
                          </div>
                      </div>
                  `
          }
        } else {
          if (currentDate === today) {
            timeRangeText.innerHTML = `
                      <div style="font-size: 0.9em;">
                          <div><strong>選擇時區：</strong>${timezoneName}</div>
                          <div><strong>生成天數：</strong>${batchDays} 天 (${endDateStr} ~ ${currentDate})</div>
                          <div><strong>UTC 時間範圍：</strong>${utcStartStr} ~ ${multiDayUtcEndStr}</div>
                          <div style="color: #666; margin-top: 5px;">
                              <small>注意：第1天時間限制在當前時間之前，其他天為全天24小時</small>
                          </div>
                      </div>
                  `
          } else {
            timeRangeText.innerHTML = `
                      <div style="font-size: 0.9em;">
                          <div><strong>選擇時區：</strong>${timezoneName}</div>
                          <div><strong>生成天數：</strong>${batchDays} 天 (${endDateStr} ~ ${currentDate})</div>
                          <div><strong>UTC 時間範圍：</strong>${utcStartStr} ~ ${multiDayUtcEndStr}</div>
                          <div style="color: #666; margin-top: 5px;">
                              <small>注意：所有天都可以生成全天24小時的任意時間</small>
                          </div>
                      </div>
                  `
          }
        }
      }

      // 從帳號原始值更新卡片信息
      function updateCardInfoFromAcctNumber() {
        const acctNumber = document.getElementById('acctNumber').value

        if (acctNumber.length >= 6) {
          // 更新 cardbin6 (前6碼)
          document.getElementById('cardbin6').value = acctNumber.substring(0, 6)
        }

        if (acctNumber.length >= 8) {
          // 更新 cardbin8 (前8碼)
          document.getElementById('cardbin8').value = acctNumber.substring(0, 8)
        }

        if (acctNumber.length >= 10) {
          // 更新 acctNumberMask (前6碼 + ****** + 後4碼)
          const first6 = acctNumber.substring(0, 6)
          const last4 = acctNumber.substring(acctNumber.length - 4)
          document.getElementById('acctNumberMask').value = first6 + '******' + last4
        }

        // 計算並更新 acctNumberHashed
        if (acctNumber.length >= 10) {
          calculateAcctNumberHashed(acctNumber)
        }
      }

      // 計算 acctNumberHashed (HMAC-SHA256 + Base64)
      async function calculateAcctNumberHashed(acctNumber) {
        try {
          // 使用 Web Crypto API 計算 HMAC-SHA256
          const encoder = new TextEncoder()
          const keyData = encoder.encode('default_hmac_key') // 預設 HMAC 金鑰
          const messageData = encoder.encode(acctNumber)

          const key = await crypto.subtle.importKey(
            'raw',
            keyData,
            { name: 'HMAC', hash: 'SHA-256' },
            false,
            ['sign']
          )

          const signature = await crypto.subtle.sign('HMAC', key, messageData)
          const hashArray = new Uint8Array(signature)
          const hashBase64 = btoa(String.fromCharCode.apply(null, hashArray))

          document.getElementById('acctNumberHashed').value = hashBase64
        } catch (error) {
          console.error('計算 acctNumberHashed 失敗:', error)
          // 如果 Web Crypto API 不可用，使用預設值
          document.getElementById('acctNumberHashed').value =
            '2hpBkDB7ELbcpebGl5RM+HWTQGx3qciOwskcbsEVKC4='
        }
      }

      // 生成隨機 Mastercard 訊息擴展
      function generateRandomMastercardExtension() {
        const scores = Array.from({ length: 651 }, (_, i) => i) // 0-650
        const decisions = ['Not Low Risk', 'Low Risk']

        return {
          score: scores[Math.floor(Math.random() * scores.length)],
          reasonCode2: '', // 保持預設值，不隨機
          reasonCode1: 'A', // 保持預設值，不隨機
          decision: decisions[Math.floor(Math.random() * decisions.length)],
          status: 'success' // 保持預設值，不隨機
        }
      }

      // 生成隨機帳號原始值
      function generateRandomAcctNumber() {
        const cardScheme = document.getElementById('cardScheme').value
        let randomAcctNumber = ''

        if (cardScheme === 'V') {
          // Visa: 4143520000000000~4143529999999999
          const randomSuffix = Math.floor(Math.random() * 10000000000000)
            .toString()
            .padStart(13, '0')
          randomAcctNumber = '414352' + randomSuffix
        } else if (cardScheme === 'M') {
          // MasterCard: 5153520000000000~5153529999999999
          const randomSuffix = Math.floor(Math.random() * 10000000000000)
            .toString()
            .padStart(13, '0')
          randomAcctNumber = '515352' + randomSuffix
        } else {
          // 其他卡片組織，使用預設的 Visa 格式
          const randomSuffix = Math.floor(Math.random() * 10000000000000)
            .toString()
            .padStart(13, '0')
          randomAcctNumber = '414352' + randomSuffix
        }

        document.getElementById('acctNumber').value = randomAcctNumber
        // 自動更新其他相關欄位
        updateCardInfoFromAcctNumber()
      }

      // 更新國家信息函數
      function updateCountryInfo(countryNumeric) {
        const countryMappings = {
          158: { alpha2: 'TW', alpha3: 'TWN', numeric: '158', name: 'Taiwan' },
          840: { alpha2: 'US', alpha3: 'USA', numeric: '840', name: 'United States' },
          156: { alpha2: 'CN', alpha3: 'CHN', numeric: '156', name: 'China' },
          392: { alpha2: 'JP', alpha3: 'JPN', numeric: '392', name: 'Japan' },
          344: { alpha2: 'HK', alpha3: 'HKG', numeric: '344', name: 'Hong Kong' },
          410: { alpha2: 'KR', alpha3: 'KOR', numeric: '410', name: 'South Korea' },
          702: { alpha2: 'SG', alpha3: 'SGP', numeric: '702', name: 'Singapore' },
          '036': { alpha2: 'AU', alpha3: 'AUS', numeric: '036', name: 'Australia' },
          124: { alpha2: 'CA', alpha3: 'CAN', numeric: '124', name: 'Canada' },
          978: { alpha2: 'EU', alpha3: 'EUR', numeric: '978', name: 'European Union' },
          826: { alpha2: 'GB', alpha3: 'GBR', numeric: '826', name: 'United Kingdom' },
          764: { alpha2: 'TH', alpha3: 'THA', numeric: '764', name: 'Thailand' },
          704: { alpha2: 'VN', alpha3: 'VNM', numeric: '704', name: 'Vietnam' },
          458: { alpha2: 'MY', alpha3: 'MYS', numeric: '458', name: 'Malaysia' },
          360: { alpha2: 'ID', alpha3: 'IDN', numeric: '360', name: 'Indonesia' },
          608: { alpha2: 'PH', alpha3: 'PHL', numeric: '608', name: 'Philippines' }
        }

        if (countryMappings[countryNumeric]) {
          const countryInfo = countryMappings[countryNumeric]
          document.getElementById('countryAlpha2').value = countryInfo.alpha2
          document.getElementById('countryAlpha3').value = countryInfo.alpha3
          document.getElementById('countryNumeric').value = countryInfo.numeric
          document.getElementById('countryName').value = countryInfo.name
        }
      }

      function selectCurrency(numeric, code, name, country) {
        // 更新購買貨幣代碼
        document.getElementById('purchaseCurrency').value = numeric

        // 更新相關的貨幣信息
        document.getElementById('currencyCodeForRate').value = code
        document.getElementById('currencyAlphabeticCode').value = code
        document.getElementById('currencyNumericCode').value = numeric
        document.getElementById('currencyName').value = name

        // 根據國家更新國家信息
        const countryMappings = {
          台灣: { alpha2: 'TW', alpha3: 'TWN', numeric: '158', name: 'Taiwan' },
          美國: { alpha2: 'US', alpha3: 'USA', numeric: '840', name: 'United States' },
          中國: { alpha2: 'CN', alpha3: 'CHN', numeric: '156', name: 'China' },
          日本: { alpha2: 'JP', alpha3: 'JPN', numeric: '392', name: 'Japan' },
          香港: { alpha2: 'HK', alpha3: 'HKG', numeric: '344', name: 'Hong Kong' },
          韓國: { alpha2: 'KR', alpha3: 'KOR', numeric: '410', name: 'South Korea' },
          新加坡: { alpha2: 'SG', alpha3: 'SGP', numeric: '702', name: 'Singapore' },
          澳洲: { alpha2: 'AU', alpha3: 'AUS', numeric: '036', name: 'Australia' },
          加拿大: { alpha2: 'CA', alpha3: 'CAN', numeric: '124', name: 'Canada' },
          歐元區: { alpha2: 'EU', alpha3: 'EUR', numeric: '978', name: 'European Union' },
          英國: { alpha2: 'GB', alpha3: 'GBR', numeric: '826', name: 'United Kingdom' },
          泰國: { alpha2: 'TH', alpha3: 'THA', numeric: '764', name: 'Thailand' },
          越南: { alpha2: 'VN', alpha3: 'VNM', numeric: '704', name: 'Vietnam' },
          馬來西亞: { alpha2: 'MY', alpha3: 'MYS', numeric: '458', name: 'Malaysia' },
          印尼: { alpha2: 'ID', alpha3: 'IDN', numeric: '360', name: 'Indonesia' },
          菲律賓: { alpha2: 'PH', alpha3: 'PHL', numeric: '608', name: 'Philippines' }
        }

        if (countryMappings[country]) {
          const countryInfo = countryMappings[country]
          document.getElementById('merchantCountryCode').value = countryInfo.numeric
          document.getElementById('countryAlpha2').value = countryInfo.alpha2
          document.getElementById('countryAlpha3').value = countryInfo.alpha3
          document.getElementById('countryNumeric').value = countryInfo.numeric
          document.getElementById('countryName').value = countryInfo.name
        }

        // 更新匯率目標貨幣
        document.getElementById('exchangeTarget').value = code

        // 關閉模態框
        hideCurrencySelector()

        showStatus(`已選擇 ${country} ${name} (${code})`, 'success')
      }

      // 初始化頁面
      document.addEventListener('DOMContentLoaded', function () {
        // 設定當前日期（使用本地日期，不是 UTC）
        const today = new Date()
        const dateString =
          today.getFullYear() +
          '-' +
          String(today.getMonth() + 1).padStart(2, '0') +
          '-' +
          String(today.getDate()).padStart(2, '0')
        document.getElementById('currentDate').value = dateString

        // 設定交易狀態聯動
        document.getElementById('aresTransStatus').addEventListener('change', function () {
          const aresStatus = this.value

          // 控制 rreq_transStatus 欄位的啟用/禁用
          const rreqTransStatusSelect = document.getElementById('rreqTransStatus')
          if (['C', 'D'].includes(aresStatus)) {
            // 當 ARes 狀態為 C 或 D 時，啟用 rreq_transStatus 欄位
            rreqTransStatusSelect.disabled = false
            // 如果當前是 NULL_VALUE，設為預設值
            if (rreqTransStatusSelect.value === 'NULL_VALUE') {
              rreqTransStatusSelect.value = 'Y'
            }
            // C/D 時，transStatus 應該等於 rreq_transStatus（挑戰認證結果）
            document.getElementById('transStatus').value = rreqTransStatusSelect.value
          } else {
            // 當 ARes 狀態為其他值時，禁用 rreq_transStatus 欄位並設為 NULL_VALUE
            rreqTransStatusSelect.disabled = true
            rreqTransStatusSelect.value = 'NULL_VALUE'
            // 其他情況，transStatus 等於 ares_transStatus（無摩擦認證）
            document.getElementById('transStatus').value = aresStatus
          }

          // 控制 transStatusReason 欄位的啟用/禁用
          const transStatusReasonSelect = document.getElementById('transStatusReason')
          if (aresStatus === 'R') {
            // 當 ARes 狀態為 R 時，啟用 transStatusReason 欄位
            transStatusReasonSelect.disabled = false
            // 如果當前是 NULL_VALUE，設為預設值
            if (transStatusReasonSelect.value === 'NULL_VALUE') {
              transStatusReasonSelect.value = '01'
            }
          } else {
            // 當 ARes 狀態為其他值時，禁用 transStatusReason 欄位並設為 NULL_VALUE
            transStatusReasonSelect.disabled = true
            transStatusReasonSelect.value = 'NULL_VALUE'
          }
        })

        // 設定 rreq_transStatus 變更事件監聽器
        document.getElementById('rreqTransStatus').addEventListener('change', function () {
          const aresStatus = document.getElementById('aresTransStatus').value
          if (['C', 'D'].includes(aresStatus)) {
            // 當 ares 為 C/D 時，transStatus 應該跟隨 rreq_transStatus 變化
            document.getElementById('transStatus').value = this.value
          }
        })

        // 設定商戶國家代碼變更事件
        document.getElementById('merchantCountryCode').addEventListener('change', function () {
          updateCountryInfo(this.value)
        })

        // 設定日期選擇器變更事件
        document.getElementById('currentDate').addEventListener('change', function () {
          updateTimeRangeDisplay()
        })

        // 設定時區選擇器變更事件
        document.getElementById('timezone').addEventListener('change', function () {
          updateTimeRangeDisplay()
        })

        // 天數輸入框事件監聽器
        document.getElementById('batchDays').addEventListener('input', function () {
          updateTimeRangeDisplay()
        })

        // 初始化時間區間顯示
        updateTimeRangeDisplay()

        // 設定 Mastercard 訊息擴展開關事件
        document
          .getElementById('enableMastercardExtension')
          .addEventListener('change', function () {
            const container = document.getElementById('mastercardExtensionContainer')
            if (this.checked) {
              container.style.display = 'block'
            } else {
              container.style.display = 'none'
            }
            // 處理卡片組織強制設置
            handleMastercardToggle()
          })

        // 設定 Visa Score 開關事件
        document.getElementById('enableVisaScoreRandom').addEventListener('change', function () {
          // 處理卡片組織強制設置
          handleVisaScoreToggle()
        })

        // 初始化 Mastercard 訊息擴展容器顯示狀態
        const enableMastercardExtension = document.getElementById('enableMastercardExtension')
        const container = document.getElementById('mastercardExtensionContainer')
        // 預設關閉 Mastercard 擴展
        enableMastercardExtension.checked = false
        container.style.display = 'none'

        // 初始化卡片組織強制設置邏輯
        handleVisaScoreToggle()
        handleMastercardToggle()
      })

      // 處理 Visa Score 開關邏輯
      function handleVisaScoreToggle() {
        const visaScoreEnabled = document.getElementById('enableVisaScoreRandom').checked
        const mastercardEnabled = document.getElementById('enableMastercardExtension').checked
        const cardSchemeSelect = document.getElementById('cardScheme')
        const visaScoreCheckbox = document.getElementById('enableVisaScoreRandom')
        const mastercardCheckbox = document.getElementById('enableMastercardExtension')

        if (visaScoreEnabled) {
          // Visa Score 開啟時
          cardSchemeSelect.value = 'V'
          cardSchemeSelect.disabled = true
          mastercardCheckbox.disabled = true
          showStatus('Visa Score 已開啟，卡片組織強制設為 V (Visa)，Mastercard 已禁用', 'info')
        } else if (!mastercardEnabled) {
          // 兩個都關閉時，恢復選擇
          cardSchemeSelect.disabled = false
          mastercardCheckbox.disabled = false
          showStatus('卡片組織選擇已恢復', 'info')
        }
      }

      // 處理 Mastercard 開關邏輯
      function handleMastercardToggle() {
        const visaScoreEnabled = document.getElementById('enableVisaScoreRandom').checked
        const mastercardEnabled = document.getElementById('enableMastercardExtension').checked
        const cardSchemeSelect = document.getElementById('cardScheme')
        const visaScoreCheckbox = document.getElementById('enableVisaScoreRandom')
        const mastercardCheckbox = document.getElementById('enableMastercardExtension')

        if (mastercardEnabled) {
          // Mastercard 開啟時
          cardSchemeSelect.value = 'M'
          cardSchemeSelect.disabled = true
          visaScoreCheckbox.disabled = true
          showStatus(
            'Mastercard 擴展已開啟，卡片組織強制設為 M (Mastercard)，Visa Score 已禁用',
            'info'
          )
        } else if (!visaScoreEnabled) {
          // 兩個都關閉時，恢復選擇
          cardSchemeSelect.disabled = false
          visaScoreCheckbox.disabled = false
          showStatus('卡片組織選擇已恢復', 'info')
        }
      }

      // 載入預設值 (基於 HiTRUST demo-web 項目)

      // UUID 生成函數 (符合 3DS 規範)
      function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
          const r = (Math.random() * 16) | 0
          const v = c === 'x' ? r : (r & 0x3) | 0x8
          return v.toString(16)
        })
      }

      // 當前模式
      let currentMode = 'unified'

      // 切換模式
      function switchMode(mode) {
        currentMode = mode

        // 更新按鈕狀態
        const unifiedBtn = document.getElementById('unifiedMode')
        const acsBtn = document.getElementById('acsMode')
        const dssBtn = document.getElementById('dssMode')

        unifiedBtn.classList.toggle('active', mode === 'unified')
        acsBtn.classList.toggle('active', mode === 'acs')
        dssBtn.classList.toggle('active', mode === 'dss')

        // 更新模式指示器
        const indicator = document.getElementById('modeIndicator')
        if (mode === 'unified') {
          indicator.textContent = '統一'
          indicator.className = 'mode-indicator unified'
        } else if (mode === 'acs') {
          indicator.textContent = 'ACS'
          indicator.className = 'mode-indicator acs'
        } else {
          indicator.textContent = '3DSS'
          indicator.className = 'mode-indicator dss'
        }

        // 頁面標題已移除，無需更新

        // 更新插入按鈕文字
        updateInsertButtonText(mode)

        showStatus(`已切換到 ${getModeDisplayName(mode)} 模式`, 'success')
      }
      function loadDefaultValues() {
        // 基礎配置
        document.getElementById('baseUrl').value = 'http://localhost:9200'
        document.getElementById('username').value = 'elastic'
        document.getElementById('password').value = '123456'

        // 交易識別
        document.getElementById('issuerOid').value = 'ed8544c4-fc50-289d-ee05-ee41c86bb6f5'
        document.getElementById('acsTransId').value = generateUUID()
        document.getElementById('threeDSServerTransId').value = generateUUID().toLowerCase()

        // 交易狀態
        document.getElementById('aresTransStatus').value = 'N'
        document.getElementById('transStatus').value = 'N'
        document.getElementById('rreqTransStatus').value = 'NULL_VALUE'
        document.getElementById('transStatusReason').value = 'NULL_VALUE'

        // 商戶信息
        document.getElementById('merchantName').value = 'HiTRUST EMV Demo Merchant'
        document.getElementById('merchantCountryCode').value = '156'
        document.getElementById('acquirerMerchantId').value = '8909191'
        document.getElementById('acquirerBin').value = '1231234'
        document.getElementById('mcc').value = '5661'

        // 交易金額
        document.getElementById('purchaseAmount').value = '100'
        document.getElementById('purchaseCurrency').value = '156'
        document.getElementById('purchaseExponent').value = '2'
        document.getElementById('usdAmount').value = '0.13841979956813022'

        // 匯率信息
        document.getElementById('exchangeRate').value = '7.2244'
        document.getElementById('exchangeBase').value = 'USD'
        document.getElementById('exchangeTarget').value = 'CNY'
        document.getElementById('currencyCodeForRate').value = 'CNY'

        // 卡片信息
        document.getElementById('cardScheme').value = 'V'
        document.getElementById('acctNumber').value = '4143520000000123'
        // 自動更新其他欄位（包括計算 acctNumberHashed）
        updateCardInfoFromAcctNumber()

        // 3DS 參數
        document.getElementById('messageCategory').value = '01'
        document.getElementById('deviceChannel').value = '02'
        document.getElementById('authenticationMethod').value = 'NULL_VALUE'
        document.getElementById('authenticationType').value = 'NULL_VALUE'

        // 效能監控
        document.getElementById('performancePath').value =
          '/acs-auth/auth/V/2.2.0/ed8544c4-fc50-289d-ee05-ee41c86bb6f5/001/areq'
        document.getElementById('execTime').value = '5437'

        // 錯誤處理
        document.getElementById('errorComponent').value = 'NULL_VALUE'
        document.getElementById('errorDescription').value = 'NULL_VALUE'
        document.getElementById('errorCode').value = 'NULL_VALUE'
        document.getElementById('errorDetail').value = 'NULL_VALUE'
        document.getElementById('errorMessageType').value = 'NULL_VALUE'

        // 國家和貨幣信息
        document.getElementById('countryAlpha2').value = 'CN'
        document.getElementById('countryNumeric').value = '156'
        document.getElementById('countryAlpha3').value = 'CHN'
        document.getElementById('countryName').value = 'China'
        document.getElementById('currencyMinorUnit').value = '2'
        document.getElementById('currencyName').value = 'Yuan Renminbi'
        document.getElementById('currencyAlphabeticCode').value = 'CNY'
        document.getElementById('currencyNumericCode').value = '156'

        // 卡片組織擴展
        document.getElementById('visaDafMessageExtension').value = 'null'
        document.getElementById('enableMastercardExtension').checked = false
        document.getElementById('mastercardScore').value = '600'
        document.getElementById('mastercardDecision').value = 'Not Low Risk'
        document.getElementById('mastercardReasonCode1').value = 'A'
        document.getElementById('mastercardReasonCode2').value = ''
        document.getElementById('mastercardStatus').value = 'success'
        document.getElementById('visaRiskBasedAuthenticationScore').value = ''

        // 更新 Mastercard 擴展容器顯示狀態
        document.getElementById('mastercardExtensionContainer').style.display = 'none'

        showStatus('預設值已載入 (基於 HiTRUST demo-web 項目)', 'success')
      }

      // 生成隨機數據
      function generateRandomData() {
        const timestamp = Date.now()
        const randomId = Math.random().toString(36).substr(2, 9)

        // 交易 ID
        document.getElementById('acsTransId').value = generateUUID()
        document.getElementById('threeDSServerTransId').value = generateUUID().toLowerCase()

        // 隨機生成帳號原始值 - 只有勾選時才隨機生成
        const enableAcctNumberRandom = document.getElementById('enableAcctNumberRandom').checked
        if (enableAcctNumberRandom) {
          generateRandomAcctNumber()
        }

        // 購買金額 (10-1000) - 只有勾選時才隨機生成
        const enablePurchaseAmountRandom = document.getElementById(
          'enablePurchaseAmountRandom'
        ).checked
        if (enablePurchaseAmountRandom) {
          document.getElementById('purchaseAmount').value = (Math.random() * 990 + 10).toFixed(2)
        }

        // 執行時間 (1000-6000ms) - 只有勾選時才隨機生成
        const enableExecTimeRandom = document.getElementById('enableExecTimeRandom').checked
        if (enableExecTimeRandom) {
          document.getElementById('execTime').value = Math.floor(Math.random() * 5000 + 1000)
        }

        // 隨機交易狀態
        const statuses = ['Y', 'N', 'C', 'D', 'R', 'A', 'I', 'S', 'U']
        const randomStatus = statuses[Math.floor(Math.random() * statuses.length)]
        document.getElementById('aresTransStatus').value = randomStatus

        // transStatus 的值取決於 ares_transStatus
        if (['C', 'D'].includes(randomStatus)) {
          // C/D 時，會有 rreq_transStatus，且 transStatus = rreq_transStatus
          const randomRreqStatus = Math.random() < 0.8 ? 'Y' : 'N'
          document.getElementById('rreqTransStatus').value = randomRreqStatus
          document.getElementById('transStatus').value = randomRreqStatus
        } else {
          // 其他情況，transStatus = ares_transStatus
          document.getElementById('rreqTransStatus').value = 'NULL_VALUE'
          document.getElementById('transStatus').value = randomStatus
        }

        // 隨機 messageCategory - 只有勾選時才隨機生成
        const enableMessageCategoryRandom = document.getElementById('enableMessageCategory').checked
        if (enableMessageCategoryRandom) {
          const messageCategories = ['01', '02', '80', '85', '86']
          const randomMessageCategory =
            messageCategories[Math.floor(Math.random() * messageCategories.length)]
          document.getElementById('messageCategory').value = randomMessageCategory
        }

        // 隨機 deviceChannel - 只有勾選時才隨機生成
        const enableDeviceChannelRandom = document.getElementById('enableDeviceChannel').checked
        if (enableDeviceChannelRandom) {
          const deviceChannels = ['02', '03']
          const randomDeviceChannel =
            deviceChannels[Math.floor(Math.random() * deviceChannels.length)]
          document.getElementById('deviceChannel').value = randomDeviceChannel
        }

        // 隨機 threeDSRequestorChallengeInd - 只有勾選時才隨機生成
        const enableCiRandom = document.getElementById('enableThreeDSRequestorChallengeInd').checked
        if (enableCiRandom) {
          const cardScheme = document.getElementById('cardScheme').value
          // 基礎清單（非 Visa）
          let cis = [
            '01',
            '02',
            '03',
            '04',
            '05',
            '06',
            '07',
            '08',
            '09',
            '10',
            '11',
            '12',
            '13',
            '14'
          ]
          // Visa 才能包含 80/82
          if (cardScheme === 'V') {
            cis = cis.concat(['80', '82'])
          }
          const randomCi = cis[Math.floor(Math.random() * cis.length)]
          document.getElementById('threeDSRequestorChallengeInd').value = randomCi
        }

        // 隨機 acquirerMerchantId (1-9999999) - 只有勾選時才隨機生成
        const enableAcquirerMerchantIdRandom = document.getElementById(
          'enableAcquirerMerchantIdRandom'
        ).checked
        if (enableAcquirerMerchantIdRandom) {
          const randomAcquirerMerchantId = Math.floor(Math.random() * 9999999) + 1
          document.getElementById('acquirerMerchantId').value = randomAcquirerMerchantId.toString()
        }

        // 根據業務規則設置 transStatusReason
        if (randomStatus === 'R') {
          // ares_transStatus 是 'R' 時，transStatusReason 可能是 01~30, 81, 89, 90
          const reasons = []
          // 添加 01-30
          for (let i = 1; i <= 30; i++) {
            reasons.push(i.toString().padStart(2, '0'))
          }
          // 添加特殊值
          reasons.push('81', '89', '90')

          const randomReason = reasons[Math.floor(Math.random() * reasons.length)]
          document.getElementById('transStatusReason').value = randomReason
        } else {
          // 其他狀態時，transStatusReason 是 NULL_VALUE
          document.getElementById('transStatusReason').value = 'NULL_VALUE'
        }

        // 收單機構信息保持預設值，不隨機生成

        // Visa 風險基礎認證分數 (0-99) - 只有勾選時才隨機生成
        const enableVisaScoreRandom = document.getElementById('enableVisaScoreRandom').checked
        if (enableVisaScoreRandom) {
          document.getElementById('visaRiskBasedAuthenticationScore').value = Math.floor(
            Math.random() * 100
          )
        }

        // Mastercard 訊息擴展 - 只有啟用且勾選隨機生成時才隨機生成
        const enableMastercardExtension = document.getElementById(
          'enableMastercardExtension'
        ).checked
        const enableMastercardExtensionRandom = document.getElementById(
          'enableMastercardExtensionRandom'
        ).checked
        if (enableMastercardExtension && enableMastercardExtensionRandom) {
          const mastercardExtension = generateRandomMastercardExtension()
          document.getElementById('mastercardScore').value = mastercardExtension.score
          document.getElementById('mastercardDecision').value = mastercardExtension.decision
          document.getElementById('mastercardReasonCode1').value = mastercardExtension.reasonCode1
          document.getElementById('mastercardReasonCode2').value = mastercardExtension.reasonCode2
          document.getElementById('mastercardStatus').value = mastercardExtension.status
        }

        showStatus('隨機數據已生成', 'success')
      }

      // 清空所有欄位
      function clearAllFields() {
        const form = document.getElementById('acsForm')
        const inputs = form.querySelectorAll('input, select')
        inputs.forEach((input) => {
          if (input.type === 'date') {
            input.value = new Date().toISOString().split('T')[0]
          } else if (input.type === 'checkbox') {
            input.checked = false
          } else {
            input.value = ''
          }
        })
        // 清空 acctNumber 後，其他相關欄位也會自動清空
        updateCardInfoFromAcctNumber()

        // 確保 Mastercard 擴展容器隱藏
        const container = document.getElementById('mastercardExtensionContainer')
        container.style.display = 'none'

        showStatus('所有欄位已清空', 'success')
      }

      // 顯示狀態訊息
      function showStatus(message, type) {
        const statusDiv = document.getElementById('statusMessage')
        statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`
        // 移除自動消失，讓狀態訊息一直顯示
      }

      // 顯示回應
      function showResponse(data) {
        const responseArea = document.getElementById('responseArea')
        const responseContent = document.getElementById('responseContent')

        responseContent.textContent = JSON.stringify(data, null, 2)
        responseArea.style.display = 'block'
      }

      // 顯示載入狀態
      function showLoading(show) {
        document.getElementById('loading').style.display = show ? 'block' : 'none'
      }

      // 獲取表單數據
      function getFormData() {
        const formData = {}
        const form = document.getElementById('acsForm')
        const inputs = form.querySelectorAll('input, select')

        inputs.forEach((input) => {
          // 排除 acctNumber 欄位，因為它不會被 POST 出去
          if (input.id !== 'acctNumber') {
            // checkbox 需要讀取 checked 屬性，轉換為 'on' 或 'off'
            if (input.type === 'checkbox') {
              formData[input.id] = input.checked ? 'on' : 'off'
            } else {
              formData[input.id] = input.value
            }
          }
        })

        // 根據開關狀態決定 Mastercard 訊息擴展
        const enableMastercardExtension = document.getElementById(
          'enableMastercardExtension'
        ).checked
        if (enableMastercardExtension) {
          // 構建 Mastercard 訊息擴展 JSON 物件
          const mastercardExtension = {
            score: parseInt(document.getElementById('mastercardScore').value),
            reasonCode2: document.getElementById('mastercardReasonCode2').value,
            reasonCode1: document.getElementById('mastercardReasonCode1').value,
            decision: document.getElementById('mastercardDecision').value,
            status: document.getElementById('mastercardStatus').value
          }
          formData.mastercardMessageExtension = JSON.stringify(mastercardExtension)
        } else {
          // 開關關閉時設為 null
          formData.mastercardMessageExtension = 'null'
        }

        // 添加當前模式
        formData.mode = currentMode

        return formData
      }

      // 生成共享時間戳（用於統一模式）
      function generateSharedTimestamp(data) {
        const currentDate = data.currentDate
        const now = new Date()
        const today =
          now.getFullYear() +
          '-' +
          String(now.getMonth() + 1).padStart(2, '0') +
          '-' +
          String(now.getDate()).padStart(2, '0')

        let randomHour, randomMinute, randomSecond

        if (currentDate === today) {
          // 如果是今天，時間不能超過當前時間
          const currentHour = now.getHours()
          const currentMinute = now.getMinutes()
          const currentSecond = now.getSeconds()

          randomHour = Math.floor(Math.random() * (currentHour + 1))
            .toString()
            .padStart(2, '0')

          if (parseInt(randomHour) === currentHour) {
            randomMinute = Math.floor(Math.random() * (currentMinute + 1))
              .toString()
              .padStart(2, '0')

            if (parseInt(randomMinute) === currentMinute) {
              randomSecond = Math.floor(Math.random() * (currentSecond + 1))
                .toString()
                .padStart(2, '0')
            } else {
              randomSecond = Math.floor(Math.random() * 60)
                .toString()
                .padStart(2, '0')
            }
          } else {
            randomMinute = Math.floor(Math.random() * 60)
              .toString()
              .padStart(2, '0')
            randomSecond = Math.floor(Math.random() * 60)
              .toString()
              .padStart(2, '0')
          }
        } else {
          // 如果是過去的日期，可以生成任意時間
          randomHour = Math.floor(Math.random() * 24)
            .toString()
            .padStart(2, '0')
          randomMinute = Math.floor(Math.random() * 60)
            .toString()
            .padStart(2, '0')
          randomSecond = Math.floor(Math.random() * 60)
            .toString()
            .padStart(2, '0')
        }

        // 構建本地時間的 Date 對象
        const userDate = new Date(`${currentDate}T${randomHour}:${randomMinute}:${randomSecond}`)

        // 獲取選定的時區
        const selectedTimezone = document.getElementById('timezone').value

        // 轉換為 UTC 時間
        let utcDate
        if (selectedTimezone === 'browser') {
          // 使用瀏覽器時區 - 直接使用 Date 對象，toISOString() 會自動轉換為 UTC
          utcDate = userDate
        } else if (selectedTimezone === 'UTC') {
          // 對於 UTC 時區，直接使用日期，不需要轉換
          utcDate = userDate
        } else {
          // 使用指定時區
          utcDate = convertToUTC(userDate, selectedTimezone)
        }
        const currentDateTime = utcDate.toISOString()

        return {
          currentDateTime,
          randomHour,
          randomMinute,
          randomSecond
        }
      }

      // 構建 Elasticsearch 文檔（使用預先生成的時間戳）
      function buildElasticsearchDocumentWithTimestamp(data, indexName = null, sharedTimestamp) {
        const currentDateTime = sharedTimestamp.currentDateTime

        // 生成隨機的歷史匯率日期（真實數據中可能是歷史日期）
        const now = new Date()
        const randomDaysAgo = Math.floor(Math.random() * 365)
        const historicalDate = new Date(now.getTime() - randomDaysAgo * 24 * 60 * 60 * 1000)
        const historicalDateStr = historicalDate.toISOString().split('T')[0]

        // 調試日誌
        console.log('=== buildElasticsearchDocumentWithTimestamp 調試 ===')
        console.log('當前模式:', data.mode)
        console.log('索引名稱:', indexName)
        console.log('acsTransId 值:', data.acsTransId)
        console.log('issuerOid 值:', data.issuerOid)
        console.log('threeDSServerTransId 值:', data.threeDSServerTransId)

        // 根據模式決定要包含哪些欄位
        const document = {
          visaDafMessageExtension:
            data.visaDafMessageExtension === 'null' ? null : data.visaDafMessageExtension,
          errorComponent: data.errorComponent === 'NULL_VALUE' ? 'NULL_VALUE' : data.errorComponent,
          messageCategory: data.messageCategory,
          usdAmount: parseFloat(data.usdAmount),
          errorDescription:
            data.errorDescription === 'NULL_VALUE' ? 'NULL_VALUE' : data.errorDescription,
          merchantCountryCode: data.merchantCountryCode,
          cardScheme: data.cardScheme,
          errorCode: data.errorCode === 'NULL_VALUE' ? 'NULL_VALUE' : data.errorCode,
          mastercardMessageExtension:
            data.mastercardMessageExtension === 'null'
              ? null
              : data.mastercardMessageExtension.startsWith('{')
                ? JSON.parse(data.mastercardMessageExtension)
                : data.mastercardMessageExtension,
          mcc: data.mcc,
          purchaseCurrency: data.purchaseCurrency,
          merchantName: data.merchantName,
          last_update_timestamp: currentDateTime,
          cardbin6: data.cardbin6,
          transStatusReason:
            data.transStatusReason === 'NULL_VALUE' ? 'NULL_VALUE' : data.transStatusReason,
          acquirerMerchantID: String(data.acquirerMerchantId),
          exchangeKey: `${data.currencyCodeForRate}-${currentDateTime.split('T')[0]}`,
          errorDetail: data.errorDetail === 'NULL_VALUE' ? 'NULL_VALUE' : data.errorDetail,
          purchaseCurrencyStr: data.purchaseCurrency,
          'purchaseCurrency-country_info': {
            'ISO4217-currency_minor_unit': data.currencyMinorUnit,
            'ISO4217-currency_name': data.currencyName,
            'ISO4217-currency_alphabetic_code': data.currencyAlphabeticCode,
            'ISO4217-currency_numeric_code': data.currencyNumericCode
          },
          transStatus: data.transStatus,
          first_seen_timestamp: currentDateTime,
          merchantCountryCodeStr: data.merchantCountryCode,
          performance_metrics: [
            {
              path: data.performancePath,
              execTime: parseInt(data.execTime)
            }
          ],
          exchange_rate: {
            date: `${historicalDateStr}T00:00:00.000Z`,
            '@timestamp': `${historicalDateStr}T00:00:02.000Z`,
            rate: data.exchangeRate,
            target: data.exchangeTarget,
            base: data.exchangeBase
          },
          visaScoreMessageExtension:
            data.visaRiskBasedAuthenticationScore &&
            data.visaRiskBasedAuthenticationScore.toString().trim() !== ''
              ? {
                  visaRiskBasedAuthenticationScore: parseInt(data.visaRiskBasedAuthenticationScore)
                }
              : null,
          cardbin8: data.cardbin8,
          errorMessageType:
            data.errorMessageType === 'NULL_VALUE' ? 'NULL_VALUE' : data.errorMessageType,
          merchantCountryCode_country_info: {
            'ISO3166-1-Alpha-2': data.countryAlpha2,
            'ISO3166-1-numeric': data.countryNumeric,
            'ISO3166-1-Alpha-3': data.countryAlpha3,
            official_name_en: data.countryName
          },
          acquirerBIN: data.acquirerBin,
          deviceChannel: data.deviceChannel,
          acctNumberHashed: data.acctNumberHashed,
          purchaseAmount: data.purchaseAmount,
          currencyCodeForRate: data.currencyCodeForRate,
          purchaseExponent: data.purchaseExponent,
          authenticationMethod:
            data.authenticationMethod === 'NULL_VALUE' ? 'NULL_VALUE' : data.authenticationMethod,
          rreq_transStatus:
            data.rreqTransStatus === 'NULL_VALUE' ? 'NULL_VALUE' : data.rreqTransStatus,
          authenticationType:
            data.authenticationType === 'NULL_VALUE' ? 'NULL_VALUE' : data.authenticationType,
          threedsRequestorChlgInd: data.threeDSRequestorChallengeInd,
          ares_transStatus: data.aresTransStatus,
          acctNumberMask: data.acctNumberMask
        }

        // 根據模式和索引名稱決定要包含哪些欄位
        const isAcsIndex =
          data.mode === 'acs' ||
          (data.mode === 'unified' && indexName && indexName.includes('acs-transaction'))
        const isDssIndex =
          data.mode === 'dss' ||
          (data.mode === 'unified' && indexName && indexName.includes('3dss-transaction'))

        if (isAcsIndex) {
          // ACS 索引：添加 acsTransID 和 issuerOid
          document.acsTransID = data.acsTransId
          document.issuerOid = data.issuerOid
          console.log('✅ 添加 ACS 欄位:', {
            acsTransID: data.acsTransId,
            issuerOid: data.issuerOid
          })
        } else {
          console.log('❌ 跳過 ACS 欄位')
        }

        if (isDssIndex) {
          // 3DSS 索引：添加 threeDSServerTransID
          document.threeDSServerTransID = data.threeDSServerTransId
          console.log('✅ 添加 3DSS 欄位:', {
            threeDSServerTransID: data.threeDSServerTransId
          })
        } else {
          console.log('❌ 跳過 3DSS 欄位')
        }

        return document
      }

      // 構建 Elasticsearch 文檔
      function buildElasticsearchDocument(data, indexName = null) {
        const currentDate = data.currentDate
        // 使用用戶輸入的日期，並生成隨機時間（不超過當前時間），然後調整為 UTC 時間（-8小時）
        const now = new Date()
        // 使用本地日期來比較，確保格式一致
        const today =
          now.getFullYear() +
          '-' +
          String(now.getMonth() + 1).padStart(2, '0') +
          '-' +
          String(now.getDate()).padStart(2, '0')

        let randomHour, randomMinute, randomSecond

        // 調試日誌
        console.log('日期比較:', {
          currentDate,
          today,
          isToday: currentDate === today,
          currentYear: now.getFullYear(),
          currentMonth: now.getMonth() + 1,
          currentDay: now.getDate()
        })

        if (currentDate === today) {
          // 如果是今天，時間不能超過當前時間
          const currentHour = now.getHours()
          const currentMinute = now.getMinutes()
          const currentSecond = now.getSeconds()

          randomHour = Math.floor(Math.random() * (currentHour + 1))
            .toString()
            .padStart(2, '0')

          if (parseInt(randomHour) === currentHour) {
            // 如果是當前小時，分鐘不能超過當前分鐘
            randomMinute = Math.floor(Math.random() * (currentMinute + 1))
              .toString()
              .padStart(2, '0')

            if (parseInt(randomMinute) === currentMinute) {
              // 如果是當前分鐘，秒數不能超過當前秒數
              randomSecond = Math.floor(Math.random() * (currentSecond + 1))
                .toString()
                .padStart(2, '0')
            } else {
              randomSecond = Math.floor(Math.random() * 60)
                .toString()
                .padStart(2, '0')
            }
          } else {
            randomMinute = Math.floor(Math.random() * 60)
              .toString()
              .padStart(2, '0')
            randomSecond = Math.floor(Math.random() * 60)
              .toString()
              .padStart(2, '0')
          }
        } else {
          // 如果是過去的日期，可以生成任意時間
          randomHour = Math.floor(Math.random() * 24)
            .toString()
            .padStart(2, '0')
          randomMinute = Math.floor(Math.random() * 60)
            .toString()
            .padStart(2, '0')
          randomSecond = Math.floor(Math.random() * 60)
            .toString()
            .padStart(2, '0')
        }

        const userDate = new Date(`${currentDate}T${randomHour}:${randomMinute}:${randomSecond}`)

        // 根據選擇的時區進行 UTC 轉換
        const selectedTimezone = data.timezone || 'browser'
        let utcDate

        if (selectedTimezone === 'browser') {
          // 使用瀏覽器時區
          const timezoneOffset = userDate.getTimezoneOffset() // 分鐘為單位，負值表示比 UTC 早
          utcDate = new Date(userDate.getTime() + timezoneOffset * 60 * 1000) // 加上偏移量轉為 UTC
        } else {
          // 使用指定時區
          utcDate = convertToUTC(userDate, selectedTimezone)
        }

        const currentDateTime = utcDate.toISOString()

        // 生成隨機的歷史匯率日期（真實數據中可能是歷史日期）
        const randomDaysAgo = Math.floor(Math.random() * 365)
        const historicalDate = new Date(now.getTime() - randomDaysAgo * 24 * 60 * 60 * 1000)
        const historicalDateStr = historicalDate.toISOString().split('T')[0]

        // 調試日誌
        console.log('=== buildElasticsearchDocument 調試 ===')
        console.log('當前模式:', data.mode)
        console.log('索引名稱:', indexName)
        console.log('acsTransId 值:', data.acsTransId)
        console.log('issuerOid 值:', data.issuerOid)
        console.log('threeDSServerTransId 值:', data.threeDSServerTransId)

        // 根據模式決定要包含哪些欄位
        const document = {
          visaDafMessageExtension:
            data.visaDafMessageExtension === 'null' ? null : data.visaDafMessageExtension,
          errorComponent: data.errorComponent === 'NULL_VALUE' ? 'NULL_VALUE' : data.errorComponent,
          messageCategory: data.messageCategory,
          usdAmount: parseFloat(data.usdAmount),
          errorDescription:
            data.errorDescription === 'NULL_VALUE' ? 'NULL_VALUE' : data.errorDescription,
          merchantCountryCode: data.merchantCountryCode,
          cardScheme: data.cardScheme,
          errorCode: data.errorCode === 'NULL_VALUE' ? 'NULL_VALUE' : data.errorCode,
          mastercardMessageExtension:
            data.mastercardMessageExtension === 'null'
              ? null
              : data.mastercardMessageExtension.startsWith('{')
                ? JSON.parse(data.mastercardMessageExtension)
                : data.mastercardMessageExtension,
          mcc: data.mcc,
          purchaseCurrency: data.purchaseCurrency,
          merchantName: data.merchantName,
          last_update_timestamp: currentDateTime,
          cardbin6: data.cardbin6,
          transStatusReason:
            data.transStatusReason === 'NULL_VALUE' ? 'NULL_VALUE' : data.transStatusReason,
          acquirerMerchantID: String(data.acquirerMerchantId),
          exchangeKey: `${data.currencyCodeForRate}-${currentDateTime.split('T')[0]}`,
          errorDetail: data.errorDetail === 'NULL_VALUE' ? 'NULL_VALUE' : data.errorDetail,
          purchaseCurrencyStr: data.purchaseCurrency,
          'purchaseCurrency-country_info': {
            'ISO4217-currency_minor_unit': data.currencyMinorUnit,
            'ISO4217-currency_name': data.currencyName,
            'ISO4217-currency_alphabetic_code': data.currencyAlphabeticCode,
            'ISO4217-currency_numeric_code': data.currencyNumericCode
          },
          transStatus: data.transStatus,
          first_seen_timestamp: currentDateTime,
          merchantCountryCodeStr: data.merchantCountryCode,
          performance_metrics: [
            {
              path: data.performancePath,
              execTime: parseInt(data.execTime)
            }
          ],
          exchange_rate: {
            date: `${historicalDateStr}T00:00:00.000Z`,
            '@timestamp': `${historicalDateStr}T00:00:02.000Z`,
            rate: data.exchangeRate,
            target: data.exchangeTarget,
            base: data.exchangeBase
          },
          visaScoreMessageExtension:
            data.visaRiskBasedAuthenticationScore &&
            data.visaRiskBasedAuthenticationScore.toString().trim() !== ''
              ? {
                  visaRiskBasedAuthenticationScore: parseInt(data.visaRiskBasedAuthenticationScore)
                }
              : null,
          cardbin8: data.cardbin8,
          errorMessageType:
            data.errorMessageType === 'NULL_VALUE' ? 'NULL_VALUE' : data.errorMessageType,
          merchantCountryCode_country_info: {
            'ISO3166-1-Alpha-2': data.countryAlpha2,
            'ISO3166-1-numeric': data.countryNumeric,
            'ISO3166-1-Alpha-3': data.countryAlpha3,
            official_name_en: data.countryName
          },
          acquirerBIN: data.acquirerBin,
          deviceChannel: data.deviceChannel,
          acctNumberHashed: data.acctNumberHashed,
          purchaseAmount: data.purchaseAmount,
          currencyCodeForRate: data.currencyCodeForRate,
          purchaseExponent: data.purchaseExponent,
          authenticationMethod:
            data.authenticationMethod === 'NULL_VALUE' ? 'NULL_VALUE' : data.authenticationMethod,
          rreq_transStatus:
            data.rreqTransStatus === 'NULL_VALUE' ? 'NULL_VALUE' : data.rreqTransStatus,
          authenticationType:
            data.authenticationType === 'NULL_VALUE' ? 'NULL_VALUE' : data.authenticationType,
          threedsRequestorChlgInd: data.threeDSRequestorChallengeInd,
          threedsRequestorChlgInd: data.threeDSRequestorChallengeInd,
          ares_transStatus: data.aresTransStatus,
          acctNumberMask: data.acctNumberMask
        }

        // 根據模式和索引名稱決定要包含哪些欄位
        const isAcsIndex =
          data.mode === 'acs' ||
          (data.mode === 'unified' && indexName && indexName.includes('acs-transaction'))
        const isDssIndex =
          data.mode === 'dss' ||
          (data.mode === 'unified' && indexName && indexName.includes('3dss-transaction'))

        if (isAcsIndex) {
          // ACS 索引：添加 acsTransID 和 issuerOid
          document.acsTransID = data.acsTransId
          document.issuerOid = data.issuerOid
          console.log('✅ 添加 ACS 欄位:', {
            acsTransID: data.acsTransId,
            issuerOid: data.issuerOid
          })
        } else {
          console.log('❌ 跳過 ACS 欄位')
        }

        if (isDssIndex) {
          // 3DSS 索引：添加 threeDSServerTransID
          document.threeDSServerTransID = data.threeDSServerTransId
          console.log('✅ 添加 3DSS 欄位:', { threeDSServerTransID: data.threeDSServerTransId })
        } else {
          console.log('❌ 跳過 3DSS 欄位')
        }

        console.log('最終文檔欄位:', Object.keys(document))
        console.log('=== 調試結束 ===')

        return document
      }

      // 插入測試數據（增強版）
      async function insertTestData() {
        try {
          // 移除 showLoading，使用通知面板顯示進度
          const formData = getFormData()

          // 顯示單次操作的通知
          showSingleOperationNotification()

          if (currentMode === 'unified') {
            // 統一模式：同時插入到 ACS 和 3DSS
            addLogEntry('info', '開始統一模式插入（ACS + 3DSS）')
            await insertToBothIndexes(formData)
          } else {
            // 單一模式：插入到指定索引
            const indexName = currentMode === 'acs' ? 'acs-transaction' : '3dss-transaction'
            addLogEntry('info', `開始單一模式插入（${indexName}）`)
            await insertToSingleIndex(formData, indexName)
          }
        } catch (error) {
          console.error('插入測試數據失敗:', error)
          addLogEntry('error', `插入失敗: ${error.message}`)
          showStatus('插入測試數據失敗: ' + error.message, 'error')
        } finally {
          // 移除 showLoading，使用通知面板顯示進度
        }
      }

      // 顯示單次操作通知
      function showSingleOperationNotification() {
        notificationState = {
          isVisible: true,
          isMinimized: false,
          startTime: Date.now(),
          totalCount: 1,
          currentCount: 0,
          successCount: 0,
          errorCount: 0,
          errors: [],
          logs: []
        }

        // 重置 UI
        document.getElementById('notificationPanel').style.display = 'block'
        document.getElementById('minimizedNotification').style.display = 'none'
        updateProgressUI()
        addLogEntry('info', '開始單次數據插入操作')
      }
      // 插入到兩個索引（ACS 和 3DSS）（增強版）
      async function insertToBothIndexes(formData) {
        // 更新總計為 2（ACS + 3DSS）
        notificationState.totalCount = 2
        updateProgressUI()

        // 生成共享時間戳，確保 ACS 和 3DSS 使用相同的時間
        const sharedTimestamp = generateSharedTimestamp(formData)

        addLogEntry('info', '開始插入到 ACS 索引...')
        const acsResult = await insertToUnifiedIndexSilent(
          formData,
          'acs-transaction',
          sharedTimestamp
        )

        notificationState.currentCount++
        if (acsResult.success) {
          notificationState.successCount++
          addLogEntry('success', 'ACS 索引插入成功')
        } else {
          notificationState.errorCount++
          const errorMsg = `ACS 索引插入失敗: ${acsResult.error}`
          notificationState.errors.push(errorMsg)
          addLogEntry('error', errorMsg)
        }
        updateProgressUI()
        updateErrorDetails()

        addLogEntry('info', '開始插入到 3DSS 索引...')
        const dssResult = await insertToUnifiedIndexSilent(
          formData,
          '3dss-transaction',
          sharedTimestamp
        )

        notificationState.currentCount++
        if (dssResult.success) {
          notificationState.successCount++
          addLogEntry('success', '3DSS 索引插入成功')
        } else {
          notificationState.errorCount++
          const errorMsg = `3DSS 索引插入失敗: ${dssResult.error}`
          notificationState.errors.push(errorMsg)
          addLogEntry('error', errorMsg)
        }
        updateProgressUI()
        updateErrorDetails()

        // 完成處理
        document.getElementById('progressStatus').textContent = '處理完成'
        addLogEntry(
          'info',
          `統一模式插入完成！成功: ${notificationState.successCount}, 失敗: ${notificationState.errorCount}`
        )

        if (acsResult.success && dssResult.success) {
          showStatus('測試數據已成功插入到 ACS 和 3DSS 索引', 'success')
          // 移除 showResponse，使用通知面板顯示結果
        } else {
          const errors = []
          if (!acsResult.success) errors.push('ACS: ' + acsResult.error)
          if (!dssResult.success) errors.push('3DSS: ' + dssResult.error)
          showStatus('部分插入失敗: ' + errors.join(', '), 'error')
        }
      }

      // 插入到單一索引（增強版）
      async function insertToSingleIndex(formData, indexName) {
        try {
          addLogEntry('info', `準備插入到索引: ${indexName}`)

          // 先構建文檔以獲取 UTC 時間
          const document = buildElasticsearchDocument(formData, indexName)
          // 基於 UTC 時間的日期來決定索引名稱
          const utcDateStr = document.last_update_timestamp.split('T')[0]
          const fullIndexName = `${indexName}-${utcDateStr}`

          addLogEntry('info', `目標索引: ${fullIndexName}`)

          // 構建 bulk API 請求
          const bulkData =
            [JSON.stringify({ index: { _index: fullIndexName } }), JSON.stringify(document)].join(
              '\n'
            ) + '\n'

          addLogEntry('info', '發送請求到 Elasticsearch...')

          const response = await fetch(`${formData.baseUrl}/_bulk`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-ndjson',
              Authorization: 'Basic ' + btoa(`${formData.username}:${formData.password}`)
            },
            body: bulkData
          })

          const result = await response.json()

          if (response.ok) {
            addLogEntry('success', `成功插入到 ${fullIndexName}`)
            return { success: true, result: result }
          } else {
            const errorMsg = result.error || '插入失敗'
            addLogEntry('error', `插入失敗: ${errorMsg}`)
            return { success: false, error: errorMsg }
          }
        } catch (error) {
          addLogEntry('error', `插入異常: ${error.message}`)
          return { success: false, error: error.message }
        }
      }
    </script>
  </body>
</html>
